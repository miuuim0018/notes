<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- viewport-fit=cover ensures layout extends to full screen including notch area -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>äº”åéŸ³è¨˜æ†¶ç¥å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        /* Disable double-tap zoom globally */
        html, body {
            touch-action: manipulation; /* é—œéµä¿®æ­£ï¼šç¦ç”¨é›™æ“Šæ”¾å¤§ï¼Œä¸¦åŠ é€Ÿé»æ“Šåæ‡‰ */
            -ms-touch-action: manipulation;
        }

        /* Custom CSS for 3D Flip */
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        /* Custom Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }

        /* Hide scrollbar for cleaner UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Safe area padding for iPhone X+ Home Indicator */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }

        /* Disable selection to feel like an App */
        body { -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }

        /* Desktop Hover Effects */
        @media (min-width: 768px) {
            .hover-scale { transition: transform 0.2s; }
            .hover-scale:hover { transform: scale(1.02); }
        }
    </style>
</head>
<!-- Use h-[100dvh] for dynamic viewport height on mobile browsers -->
<body class="bg-slate-100 font-sans text-slate-800 h-[100dvh] w-screen overflow-hidden">

    <div id="app" class="flex flex-col md:flex-row h-full w-full">
        
        <!-- 1. DESKTOP SIDEBAR (Hidden on Mobile) -->
        <aside class="hidden md:flex flex-col w-64 bg-white border-r border-slate-200 h-full shadow-sm z-20 shrink-0">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">ã‚</div>
                <h1 class="font-bold text-xl text-slate-800">äº”åéŸ³è¨˜æ†¶</h1>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button @click="setActiveTab('list')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all" :class="activeTab === 'list' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-500 hover:bg-slate-50'">
                    <icon-book size="20"></icon-book> å–®å­—åˆ—è¡¨
                </button>
                <button @click="setActiveTab('flashcards')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all" :class="activeTab === 'flashcards' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-500 hover:bg-slate-50'">
                    <icon-layers size="20"></icon-layers> èƒŒå–®å­—å¡
                </button>
                <button @click="setActiveTab('quiz')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold transition-all" :class="activeTab === 'quiz' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-500 hover:bg-slate-50'">
                    <icon-graduation-cap size="20"></icon-graduation-cap> è‡ªæˆ‘æ¸¬é©—
                </button>
            </nav>

            <div class="p-6 border-t border-slate-100 shrink-0">
                <div class="bg-slate-50 p-4 rounded-xl">
                    <div class="text-xs font-bold text-slate-400 mb-2 uppercase">å­¸ç¿’ç‹€æ…‹</div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-slate-600">æ”¶è—å–®å­—</span>
                        <span class="font-bold text-yellow-500">{{ bookmarks.length }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-slate-600">å¾…åŠ å¼·</span>
                        <span class="font-bold text-red-500">{{ missedIds.length }}</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 2. MAIN CONTENT AREA (Flex Column for layout stability) -->
        <div class="flex-1 flex flex-col h-full relative overflow-hidden">
            
            <!-- MOBILE HEADER (Hidden on Desktop) - Fixed height, shrink-0 -->
            <header class="md:hidden h-14 bg-white/90 backdrop-blur-md border-b border-slate-200 flex items-center justify-center shrink-0 z-20 pt-safe">
                <h1 class="font-bold text-slate-800 text-lg">äº”åéŸ³è¨˜æ†¶ç¥å™¨</h1>
            </header>

            <!-- CONTENT SCROLL AREA (Flex-1 takes remaining space) -->
            <main class="flex-1 overflow-hidden relative bg-slate-50/50 w-full">
                
                <!-- === TAB: LIST VIEW === -->
                <div v-if="activeTab === 'list'" class="h-full overflow-y-auto no-scrollbar p-4 md:p-8 pb-20 md:pb-8">
                    <div class="max-w-5xl mx-auto">
                        <!-- Mobile Dashboard -->
                        <div class="md:hidden bg-indigo-600 text-white p-6 rounded-2xl shadow-lg mb-8">
                            <div class="flex justify-between text-center divide-x divide-indigo-400 mb-4">
                                <div class="flex-1"><div class="text-2xl font-bold">{{ vocabularyData.length }}</div><div class="text-xs opacity-70">ç¸½æ•¸</div></div>
                                <div class="flex-1"><div class="text-2xl font-bold text-yellow-300">{{ bookmarks.length }}</div><div class="text-xs opacity-70">æ”¶è—</div></div>
                                <div class="flex-1"><div class="text-2xl font-bold text-red-300">{{ missedIds.length }}</div><div class="text-xs opacity-70">å¾…åŠ å¼·</div></div>
                            </div>
                        </div>

                        <!-- Desktop Grid / Mobile List -->
                        <div class="space-y-6">
                            <div v-for="(items, row) in groupedData" :key="row">
                                <div class="flex items-center gap-4 mb-3">
                                    <h3 class="text-lg font-bold text-slate-700">{{ row }}</h3>
                                    <div class="h-px flex-1 bg-slate-200"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 md:gap-4">
                                    <div v-for="item in items" :key="item.id" class="bg-white p-3 md:p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-all group">
                                        <div class="w-10 h-10 md:w-12 md:h-12 bg-indigo-50 rounded-xl flex items-center justify-center text-indigo-600 font-bold text-lg md:text-xl shrink-0 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                            {{ item.kana }}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-baseline justify-between">
                                                <span class="font-bold text-slate-800 text-base md:text-lg truncate">{{ item.word }}</span>
                                                <span class="text-xs text-slate-400 font-mono">{{ item.romaji }}</span>
                                            </div>
                                            <div class="text-sm text-slate-500 truncate">{{ item.meaning }}</div>
                                        </div>
                                        <button @click.stop="toggleBookmark(item.id)" class="p-2 rounded-full hover:bg-slate-50 transition-colors shrink-0" :class="hasBookmark(item.id) ? 'text-yellow-400' : 'text-slate-200 hover:text-yellow-400'">
                                            <icon-star :filled="hasBookmark(item.id)" size="20"></icon-star>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === TAB: FLASHCARDS === -->
                <div v-if="activeTab === 'flashcards'" class="h-full flex flex-col relative">
                    
                    <!-- Empty State -->
                    <div v-if="!currentDeck || currentDeck.length === 0 || !currentDeck[currentIndex]" class="flex-1 flex flex-col items-center justify-center p-6 animate-fade-in overflow-y-auto">
                        <div class="bg-white p-8 md:p-12 rounded-3xl shadow-xl border border-slate-100 text-center max-w-md w-full">
                            <div class="w-16 h-16 md:w-20 md:h-20 bg-indigo-100 rounded-full flex items-center justify-center mb-6 text-indigo-600 mx-auto">
                                <icon-layers size="40"></icon-layers>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">å–®å­—å¡ç·´ç¿’</h2>
                            <p class="text-slate-500 mb-8">è«‹é¸æ“‡è¦ç·´ç¿’çš„ç¯„åœ</p>
                            <div class="space-y-3">
                                <button @click="startSession('all')" class="w-full flex items-center justify-center gap-3 bg-indigo-600 text-white px-6 py-4 rounded-xl font-bold hover:bg-indigo-700 active:scale-95 transition-all shadow-md">
                                    <icon-layers></icon-layers> å…¨éƒ¨å–®å­— ({{ vocabularyData.length }})
                                </button>
                                <button @click="startSession('bookmarks')" :disabled="bookmarks.length === 0" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-slate-100 text-slate-700 px-6 py-4 rounded-xl font-bold hover:border-indigo-200 hover:text-indigo-600 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    <icon-star class="text-yellow-400" filled="true"></icon-star> æ”¶è—å–®å­— ({{ bookmarks.length }})
                                </button>
                                <button v-if="missedIds.length > 0" @click="startSession('missed')" class="w-full flex items-center justify-center gap-3 bg-red-50 border-2 border-red-100 text-red-600 px-6 py-4 rounded-xl font-bold hover:bg-red-100 hover:border-red-200 active:scale-95 transition-all">
                                    <icon-refresh-cw></icon-refresh-cw> éŒ¯é¡Œè¤‡ç¿’ ({{ missedIds.length }})
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Result Screen -->
                    <div v-else-if="roundComplete" class="flex-1 flex flex-col items-center justify-center p-6 animate-fade-in overflow-y-auto">
                        <div class="bg-white p-8 md:p-12 rounded-3xl shadow-xl border border-slate-100 text-center max-w-md w-full">
                            <div class="w-16 h-16 md:w-20 md:h-20 bg-yellow-100 rounded-full flex items-center justify-center mb-6 text-yellow-600 mx-auto">
                                <icon-trophy size="40"></icon-trophy>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">ç·´ç¿’å®Œæˆï¼</h2>
                            <div class="flex justify-center gap-8 my-8">
                                <div><div class="text-3xl font-black text-green-500">{{ sessionLearnedCount }}</div><div class="text-xs text-slate-400 font-bold uppercase tracking-wider">æœ¬è¼ªè¨˜ä½</div></div>
                                <div><div class="text-3xl font-black text-red-500">{{ missedIds.length }}</div><div class="text-xs text-slate-400 font-bold uppercase tracking-wider">å‰©é¤˜å¾…åŠ å¼·</div></div>
                            </div>
                            <div class="space-y-3">
                                <button v-if="missedIds.length > 0" @click="startSession('missed')" class="w-full bg-indigo-600 text-white px-6 py-4 rounded-xl font-bold hover:bg-indigo-700 shadow-lg">ç¹¼çºŒè¤‡ç¿’éŒ¯é¡Œ</button>
                                <button @click="startSession('all')" class="w-full bg-slate-100 text-slate-600 px-6 py-4 rounded-xl font-bold hover:bg-slate-200">å…¨éƒ¨é‡ä¾†</button>
                            </div>
                        </div>
                    </div>

                    <!-- Active Flashcard View -->
                    <div v-else class="flex-1 flex flex-col items-center p-4 md:p-8 h-full">
                        <!-- Top Controls -->
                        <div class="w-full max-w-md flex justify-between items-center mb-4 shrink-0">
                            <button @click="toggleFlashcardMode" class="bg-white px-3 py-2 rounded-lg text-xs md:text-sm font-bold text-slate-600 shadow-sm border border-slate-200 active:bg-slate-50 flex items-center gap-2">
                                <icon-arrow-left-right size="14"></icon-arrow-left-right> {{ flashcardMode === 'jp-zh' ? 'æ—¥ â®• ä¸­' : 'ä¸­ â®• æ—¥' }}
                            </button>
                            <span class="font-mono font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-lg text-xs md:text-sm">{{ currentIndex + 1 }} / {{ currentDeck.length }}</span>
                            <button @click="shuffleDeck" class="p-2 text-slate-400 active:text-indigo-600 bg-white rounded-lg shadow-sm border border-slate-200">
                                <icon-shuffle size="18"></icon-shuffle>
                            </button>
                        </div>

                        <!-- Card Area (Flex grow/shrink to fit) -->
                        <div class="flex-1 w-full max-w-md min-h-0 flex items-center justify-center mb-4 relative">
                            <div class="relative w-full h-full max-h-[60vh] md:max-h-[600px] aspect-[3/4] md:aspect-[4/3] perspective-1000 cursor-pointer group"
                                 @click="isFlipped = !isFlipped"
                                 @touchstart="onTouchStart"
                                 @touchend="onTouchEnd">
                                <div class="relative w-full h-full transition-all duration-300 preserve-3d" :class="{ 'rotate-y-180': isFlipped }">
                                    <!-- FRONT -->
                                    <div class="absolute inset-0 backface-hidden bg-white rounded-[2rem] shadow-lg border-2 border-white flex flex-col items-center justify-center p-6 md:p-12 z-10 relative overflow-hidden">
                                        <!-- Hints for Swipe (Mobile Only) -->
                                        <div class="md:hidden absolute left-0 top-0 bottom-0 w-8 flex items-center justify-center bg-gradient-to-r from-red-50/50 to-transparent text-red-200 opacity-0 transition-opacity duration-300" :class="{ 'opacity-100': touchStartX && touchCurrentX && (touchCurrentX - touchStartX < -30) }">
                                            <icon-x size="24"></icon-x>
                                        </div>
                                        <div class="md:hidden absolute right-0 top-0 bottom-0 w-8 flex items-center justify-center bg-gradient-to-l from-green-50/50 to-transparent text-green-200 opacity-0 transition-opacity duration-300" :class="{ 'opacity-100': touchStartX && touchCurrentX && (touchCurrentX - touchStartX > 30) }">
                                            <icon-check size="24"></icon-check>
                                        </div>

                                        <button @click.stop="toggleBookmark(currentItem.id)" class="absolute top-4 right-4 p-2 rounded-full active:bg-slate-50">
                                            <icon-star :filled="hasBookmark(currentItem.id)" size="24" :class="hasBookmark(currentItem.id) ? 'text-yellow-400' : 'text-slate-200'"></icon-star>
                                        </button>
                                        <span class="text-[10px] md:text-xs font-bold text-indigo-400 tracking-widest mb-4 md:mb-6">QUESTION</span>
                                        <h2 class="font-bold text-slate-800 text-center break-words leading-tight" :class="flashcardMode === 'jp-zh' ? 'text-5xl md:text-7xl' : 'text-3xl md:text-5xl'">
                                            {{ flashcardMode === 'jp-zh' ? currentItem.word : currentItem.meaning }}
                                        </h2>
                                        <p class="mt-6 md:mt-8 text-slate-300 text-xs md:text-sm font-bold animate-pulse">é»æ“Šç¿»é¢</p>
                                    </div>
                                    <!-- BACK -->
                                    <div class="absolute inset-0 backface-hidden bg-indigo-600 rounded-[2rem] shadow-lg border-2 border-indigo-500 rotate-y-180 flex flex-col items-center justify-center p-6 md:p-12 text-white">
                                        <button @click.stop="toggleBookmark(currentItem.id)" class="absolute top-4 right-4 p-2 rounded-full active:bg-white/10">
                                            <icon-star :filled="hasBookmark(currentItem.id)" size="24" :class="hasBookmark(currentItem.id) ? 'text-yellow-400' : 'text-white/30'"></icon-star>
                                        </button>
                                        <span class="absolute top-6 left-6 text-6xl md:text-8xl font-black text-white/10 select-none">{{ currentItem.kana }}</span>
                                        <div class="z-10 text-center w-full">
                                            <template v-if="flashcardMode === 'jp-zh'">
                                                <div class="text-2xl md:text-4xl font-bold opacity-90 mb-2">{{ currentItem.kanji }}</div>
                                                <div class="text-base md:text-xl opacity-60 font-mono mb-6 md:mb-8">{{ currentItem.romaji }}</div>
                                                <div class="w-12 md:w-16 h-1 bg-white/30 rounded-full mx-auto mb-6 md:mb-8"></div>
                                                <div class="text-2xl md:text-4xl font-bold leading-snug">{{ currentItem.meaning }}</div>
                                            </template>
                                            <template v-else>
                                                <div class="text-xs opacity-60 mb-2 md:mb-4 font-bold tracking-widest">ANSWER</div>
                                                <div class="text-4xl md:text-6xl font-bold mb-2 md:mb-4">{{ currentItem.word }}</div>
                                                <div class="text-xl md:text-2xl opacity-80">{{ currentItem.kanji }}</div>
                                                <div class="text-sm md:text-lg opacity-60 font-mono mt-2">{{ currentItem.romaji }}</div>
                                            </template>
                                        </div>
                                        <div v-if="currentItem.note" class="mt-6 md:mt-8 bg-black/20 px-3 py-1 rounded-full text-xs md:text-sm font-medium backdrop-blur-sm">
                                            {{ currentItem.note }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Desktop Controls Hint (Hidden on Mobile) -->
                        <div class="hidden md:block text-center mb-2 text-slate-400 text-xs font-medium">
                            <span class="bg-white px-1.5 py-0.5 rounded border border-slate-200 mx-1">â†</span> æ²’è¨˜ä½ &nbsp; <span class="bg-white px-1.5 py-0.5 rounded border border-slate-200 mx-1">â†’</span> è¨˜ä½äº† &nbsp; <span class="bg-white px-1.5 py-0.5 rounded border border-slate-200 mx-1">Space</span> ç¿»é¢
                        </div>

                        <!-- MOBILE Action Buttons (Nav Only) -->
                        <div class="md:hidden w-full max-w-md flex gap-3 h-16 shrink-0 mb-2">
                            <button @click="prevCard" class="flex-1 bg-white border-2 border-slate-200 text-slate-500 active:bg-slate-50 rounded-2xl font-bold shadow-sm flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform">
                                <icon-chevron-left size="24"></icon-chevron-left><span class="text-xs">ä¸Šä¸€å¼µ</span>
                            </button>
                            <button @click="nextCard" class="flex-1 bg-white border-2 border-slate-200 text-slate-500 active:bg-slate-50 rounded-2xl font-bold shadow-sm flex flex-col items-center justify-center gap-1 active:scale-95 transition-transform">
                                <icon-chevron-right size="24"></icon-chevron-right><span class="text-xs">ä¸‹ä¸€å¼µ</span>
                            </button>
                        </div>
                        
                        <!-- DESKTOP Action Buttons (Grading) -->
                        <div class="hidden md:flex w-full max-w-md gap-4 mt-2">
                            <button @click="handleCardResult('missed')" class="flex-1 bg-white border-2 border-red-100 text-red-500 hover:bg-red-50 py-4 rounded-xl font-bold shadow-sm transition-all flex items-center justify-center gap-2">
                                <icon-x></icon-x> æ²’è¨˜ä½ (â†)
                            </button>
                            <button @click="handleCardResult('memorized')" class="flex-1 bg-white border-2 border-green-100 text-green-600 hover:bg-green-50 py-4 rounded-xl font-bold shadow-sm transition-all flex items-center justify-center gap-2">
                                <icon-check></icon-check> è¨˜ä½äº† (â†’)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- === TAB: QUIZ === -->
                <div v-if="activeTab === 'quiz'" class="h-full overflow-y-auto no-scrollbar">
                    <!-- Setup -->
                    <div v-if="quizPhase === 'setup'" class="flex flex-col items-center justify-center min-h-full p-6 animate-fade-in">
                        <div class="bg-white p-8 md:p-12 rounded-3xl shadow-xl border border-slate-100 w-full max-w-lg my-auto">
                            <div class="w-16 h-16 md:w-20 md:h-20 bg-indigo-100 rounded-full flex items-center justify-center mb-8 text-indigo-600 mx-auto">
                                <icon-settings size="32"></icon-settings>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-8 text-center">æ¸¬é©—è¨­å®š</h2>
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider">é¡Œåº«ä¾†æº</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button @click="quizConfig.source = 'all'" class="py-3 rounded-xl font-bold border-2 transition-colors" :class="quizConfig.source === 'all' ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-100 bg-slate-50 text-slate-500 hover:border-indigo-200'">å…¨éƒ¨</button>
                                        <button @click="quizConfig.source = 'bookmarks'" :disabled="bookmarks.length === 0" class="py-3 rounded-xl font-bold border-2 transition-colors disabled:opacity-50" :class="quizConfig.source === 'bookmarks' ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-100 bg-slate-50 text-slate-500 hover:border-indigo-200'">æ”¶è—</button>
                                        <button @click="quizConfig.source = 'missed'" :disabled="missedIds.length === 0" class="py-3 rounded-xl font-bold border-2 transition-colors disabled:opacity-50" :class="quizConfig.source === 'missed' ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-100 bg-slate-50 text-slate-500 hover:border-indigo-200'">éŒ¯é¡Œ</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider">é¡Œç›®æ•¸é‡</label>
                                    <div class="grid grid-cols-4 gap-2">
                                        <button v-for="opt in [5, 10, 20, 'all']" :key="opt" @click="quizConfig.count = opt" class="py-3 rounded-xl font-bold border-2 transition-colors" :class="quizConfig.count === opt ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-100 bg-slate-50 text-slate-500 hover:border-indigo-200'">{{ opt === 'all' ? 'å…¨éƒ¨' : opt }}</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider">æ¨¡å¼</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button @click="quizConfig.mode = 'jp-zh'" class="py-4 rounded-xl font-bold border-2 transition-colors" :class="quizConfig.mode === 'jp-zh' ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-100 bg-slate-50 text-slate-500 hover:border-indigo-200'">æ—¥ â®• ä¸­</button>
                                        <button @click="quizConfig.mode = 'zh-jp'" class="py-4 rounded-xl font-bold border-2 transition-colors" :class="quizConfig.mode === 'zh-jp' ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-100 bg-slate-50 text-slate-500 hover:border-indigo-200'">ä¸­ â®• æ—¥</button>
                                    </div>
                                </div>
                            </div>
                            <button @click="startQuiz" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-indigo-700 active:scale-95 transition-transform mt-8 flex items-center justify-center gap-2">
                                <icon-play-circle size="24"></icon-play-circle> é–‹å§‹æ¸¬é©—
                            </button>
                        </div>
                    </div>

                    <!-- Result -->
                    <div v-else-if="quizPhase === 'result'" class="flex flex-col items-center justify-center min-h-full p-6 text-center animate-fade-in">
                        <div class="text-8xl mb-6 filter drop-shadow-lg">{{ quizPercentage >= 80 ? 'ğŸ‰' : 'ğŸ’ª' }}</div>
                        <h2 class="text-3xl font-bold text-slate-800 mb-2">æ¸¬é©—çµæŸ</h2>
                        <div class="my-10 p-8 bg-white rounded-3xl shadow-lg border border-slate-100 w-full max-w-xs">
                            <div class="text-6xl font-black text-indigo-600 mb-2">{{ quizPercentage }}%</div>
                            <div class="text-slate-400 font-bold">ç­”å° {{ quizState.score }} / {{ quizState.questions.length }} é¡Œ</div>
                        </div>
                        <button @click="quizPhase = 'setup'" class="bg-indigo-600 text-white px-10 py-4 rounded-full font-bold shadow-xl hover:bg-indigo-700 active:scale-95 transition-transform flex items-center gap-2">
                            <icon-rotate-ccw size="20"></icon-rotate-ccw> å†æ¸¬é©—ä¸€æ¬¡
                        </button>
                    </div>

                    <!-- Playing -->
                    <div v-else class="flex flex-col min-h-full max-w-2xl mx-auto w-full p-4 md:p-8 pb-20 md:pb-8">
                        <div class="flex justify-between items-center mb-4 md:mb-6">
                            <span class="font-bold text-indigo-600 bg-indigo-50 px-4 py-1.5 rounded-full text-sm md:text-base">Q. {{ quizState.currentQIndex + 1 }} / {{ quizState.questions.length }}</span>
                            <span class="text-slate-400 font-bold text-sm md:text-base">Score: {{ quizState.score }}</span>
                        </div>

                        <div class="bg-white p-8 md:p-16 rounded-3xl shadow-lg border border-slate-100 text-center mb-4 md:mb-6 relative overflow-hidden flex-1 flex flex-col justify-center items-center min-h-[200px]">
                            <div v-if="quizState.lastCorrect === true" class="absolute inset-0 bg-green-500/10 flex items-center justify-center z-10 animate-fade-in"><icon-check class="text-green-500 drop-shadow-md" size="80"></icon-check></div>
                            <div v-if="quizState.lastCorrect === false" class="absolute inset-0 bg-red-500/10 flex items-center justify-center z-10 animate-fade-in"><icon-x class="text-red-500 drop-shadow-md" size="80"></icon-x></div>
                            
                            <span class="text-xs font-bold text-indigo-300 uppercase tracking-widest mb-4 md:mb-6">QUESTION</span>
                            <template v-if="quizConfig.mode === 'jp-zh'">
                                <h2 class="text-4xl md:text-7xl font-bold text-slate-800 mb-2 md:mb-4">{{ currentQuizItem.word }}</h2>
                                <p class="text-indigo-400 text-lg md:text-2xl font-medium">{{ currentQuizItem.kana }}</p>
                            </template>
                            <template v-else>
                                <h2 class="text-3xl md:text-5xl font-bold text-slate-800 mb-2">{{ currentQuizItem.meaning }}</h2>
                            </template>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 shrink-0">
                            <button v-for="(opt, i) in quizState.options" :key="i" 
                                :disabled="quizState.lastCorrect !== null"
                                @click="handleQuizAnswer(opt)"
                                class="p-4 md:p-5 rounded-xl text-left font-bold border-2 transition-all text-base md:text-lg relative overflow-hidden"
                                :class="getQuizOptionClass(opt)"
                            >
                                {{ quizConfig.mode === 'jp-zh' ? opt.meaning : `${opt.word}` }}
                                <span v-if="quizConfig.mode === 'zh-jp' && (quizState.lastCorrect !== null)" class="ml-2 text-sm font-normal opacity-70">({{ opt.kana }})</span>
                            </button>
                        </div>
                    </div>
                </div>

            </main>
        </div>

        <!-- 3. MOBILE BOTTOM NAV (Hidden on Desktop, Fixed height, shrink-0, Safe area padding) -->
        <nav class="md:hidden h-16 bg-white border-t border-slate-200 flex justify-around p-1 pb-safe shrink-0 z-50">
            <button @click="setActiveTab('list')" class="w-16 flex flex-col items-center justify-center rounded-xl transition-colors" :class="activeTab === 'list' ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'">
                <icon-book size="20"></icon-book>
                <span class="text-[10px] font-bold mt-1">åˆ—è¡¨</span>
            </button>
            <button @click="setActiveTab('flashcards')" class="w-16 flex flex-col items-center justify-center rounded-xl transition-colors" :class="activeTab === 'flashcards' ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'">
                <icon-layers size="20"></icon-layers>
                <span class="text-[10px] font-bold mt-1">èƒŒå–®å­—</span>
            </button>
            <button @click="setActiveTab('quiz')" class="w-16 flex flex-col items-center justify-center rounded-xl transition-colors" :class="activeTab === 'quiz' ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'">
                <icon-graduation-cap size="20"></icon-graduation-cap>
                <span class="text-[10px] font-bold mt-1">æ¸¬é©—</span>
            </button>
        </nav>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, onUnmounted } = Vue;

        // --- Clean Data (Removed 'å­—å°¾éŸ³' context for quiz) ---
        const vocabularyData = [
            { id: 'a1', kana: 'ã‚', word: 'ã‚ã—', kanji: 'è¶³', romaji: 'ashi', meaning: 'è…³ / è…¿', row: 'ã‚è¡Œ' },
            { id: 'a2', kana: 'ã„', word: 'ã„ã™', kanji: 'æ¤…å­', romaji: 'isu', meaning: 'æ¤…å­', row: 'ã‚è¡Œ' },
            { id: 'a3', kana: 'ã†', word: 'ã†ã—', kanji: 'ç‰›', romaji: 'ushi', meaning: 'ç‰›', row: 'ã‚è¡Œ' },
            { id: 'a4', kana: 'ãˆ', word: 'ãˆã', kanji: 'é§…', romaji: 'eki', meaning: 'è»Šç«™', row: 'ã‚è¡Œ' },
            { id: 'a5', kana: 'ãŠ', word: 'ãŠã‹ã—', kanji: 'ãŠè“å­', romaji: 'okashi', meaning: 'é»å¿ƒ / ç³–æœ', row: 'ã‚è¡Œ' },
            { id: 'k1', kana: 'ã‹', word: 'ã‹ãŠ', kanji: 'é¡”', romaji: 'kao', meaning: 'è‡‰', row: 'ã‹è¡Œ' },
            { id: 'k2', kana: 'ã', word: 'ãã', kanji: 'èŠ', romaji: 'kiku', meaning: 'èŠèŠ±', row: 'ã‹è¡Œ' },
            { id: 'k3', kana: 'ã', word: 'ãã—', kanji: 'æ«›', romaji: 'kushi', meaning: 'æ¢³å­', row: 'ã‹è¡Œ' },
            { id: 'k4', kana: 'ã‘', word: 'ã‘ã—ã', kanji: 'æ™¯è‰²', romaji: 'keshiki', meaning: 'é¢¨æ™¯', row: 'ã‹è¡Œ' },
            { id: 'k5', kana: 'ã“', word: 'ã“ã„', kanji: 'é¯‰', romaji: 'koi', meaning: 'é¯‰é­š', row: 'ã‹è¡Œ' },
            { id: 's1', kana: 'ã•', word: 'ã•ã‘', kanji: 'é…’', romaji: 'sake', meaning: 'é…’', row: 'ã•è¡Œ' },
            { id: 's2', kana: 'ã—', word: 'ã—ã‹', kanji: 'é¹¿', romaji: 'shika', meaning: 'é¹¿', row: 'ã•è¡Œ' },
            { id: 's3', kana: 'ã™', word: 'ã™ã—', kanji: 'å¯¿å¸', romaji: 'sushi', meaning: 'å£½å¸', row: 'ã•è¡Œ' },
            { id: 's4', kana: 'ã›', word: 'ã›ãªã‹', kanji: 'èƒŒä¸­', romaji: 'senaka', meaning: 'èƒŒéƒ¨', row: 'ã•è¡Œ' },
            { id: 's5', kana: 'ã', word: 'ãã†ã˜', kanji: 'æƒé™¤', romaji: 'souji', meaning: 'æ‰“æƒ', row: 'ã•è¡Œ' },
            { id: 't1', kana: 'ãŸ', word: 'ãŸã“', kanji: 'è›¸', romaji: 'tako', meaning: 'ç« é­š', row: 'ãŸè¡Œ' },
            { id: 't2', kana: 'ã¡', word: 'ã¡ãš', kanji: 'åœ°å›³', romaji: 'chizu', meaning: 'åœ°åœ–', row: 'ãŸè¡Œ' },
            { id: 't3', kana: 'ã¤', word: 'ã¤ããˆ', kanji: 'æœº', romaji: 'tsukue', meaning: 'æ›¸æ¡Œ', row: 'ãŸè¡Œ' },
            { id: 't4', kana: 'ã¦', word: 'ã¦', kanji: 'æ‰‹', romaji: 'te', meaning: 'æ‰‹', row: 'ãŸè¡Œ' },
            { id: 't5', kana: 'ã¨', word: 'ã¨ã‘ã„', kanji: 'æ™‚è¨ˆ', romaji: 'tokei', meaning: 'æ™‚é˜ / æ‰‹éŒ¶', row: 'ãŸè¡Œ' },
            { id: 'n1', kana: 'ãª', word: 'ãªã—', kanji: 'æ¢¨', romaji: 'nashi', meaning: 'æ¢¨å­', row: 'ãªè¡Œ' },
            { id: 'n2', kana: 'ã«', word: 'ã«ã', kanji: 'è‚‰', romaji: 'niku', meaning: 'è‚‰', row: 'ãªè¡Œ' },
            { id: 'n3', kana: 'ã¬', word: 'ã„ã¬', kanji: 'çŠ¬', romaji: 'inu', meaning: 'ç‹—', row: 'ãªè¡Œ', note: 'å–å­—å°¾éŸ³' },
            { id: 'n4', kana: 'ã­', word: 'ã­ã“', kanji: 'çŒ«', romaji: 'neko', meaning: 'è²“', row: 'ãªè¡Œ' },
            { id: 'n5', kana: 'ã®', word: 'ãã®ã“', kanji: 'èŒ¸', romaji: 'kinoko', meaning: 'è˜‘è‡', row: 'ãªè¡Œ', note: 'å–ä¸­é–“éŸ³' },
            { id: 'h1', kana: 'ã¯', word: 'ã¯ãª', kanji: 'èŠ±', romaji: 'hana', meaning: 'èŠ±', row: 'ã¯è¡Œ' },
            { id: 'h2', kana: 'ã²', word: 'ã²ã“ã†ã', kanji: 'é£›è¡Œæ©Ÿ', romaji: 'hikouki', meaning: 'é£›æ©Ÿ', row: 'ã¯è¡Œ' },
            { id: 'h3', kana: 'ãµ', word: 'ãµã­', kanji: 'èˆ¹', romaji: 'fune', meaning: 'èˆ¹', row: 'ã¯è¡Œ' },
            { id: 'h4', kana: 'ã¸', word: 'ã¸ã‚„', kanji: 'éƒ¨å±‹', romaji: 'heya', meaning: 'æˆ¿é–“', row: 'ã¯è¡Œ' },
            { id: 'h5', kana: 'ã»', word: 'ã»ã—', kanji: 'æ˜Ÿ', romaji: 'hoshi', meaning: 'æ˜Ÿæ˜Ÿ', row: 'ã¯è¡Œ' },
            { id: 'm1', kana: 'ã¾', word: 'ã¾ãã‚‰', kanji: 'æ•', romaji: 'makura', meaning: 'æ•é ­', row: 'ã¾è¡Œ' },
            { id: 'm2', kana: 'ã¿', word: 'ã¿ã¿', kanji: 'è€³', romaji: 'mimi', meaning: 'è€³æœµ', row: 'ã¾è¡Œ' },
            { id: 'm3', kana: 'ã‚€', word: 'ã‚€ã­', kanji: 'èƒ¸', romaji: 'mune', meaning: 'èƒ¸éƒ¨', row: 'ã¾è¡Œ' },
            { id: 'm4', kana: 'ã‚', word: 'ã‚ã„ã—', kanji: 'ååˆº', romaji: 'meishi', meaning: 'åç‰‡', row: 'ã¾è¡Œ' },
            { id: 'm5', kana: 'ã‚‚', word: 'ã‚‚ã‚‚', kanji: 'æ¡ƒ', romaji: 'momo', meaning: 'æ¡ƒå­', row: 'ã¾è¡Œ' },
            { id: 'y1', kana: 'ã‚„', word: 'ã‚„ã¾', kanji: 'å±±', romaji: 'yama', meaning: 'å±±', row: 'ã‚„è¡Œ' },
            { id: 'y2', kana: 'ã‚†', word: 'ã‚†ã‹ãŸ', kanji: 'æµ´è¡£', romaji: 'yukata', meaning: 'æµ´è¡£', row: 'ã‚„è¡Œ' },
            { id: 'y3', kana: 'ã‚ˆ', word: 'ã‚ˆã‚‹', kanji: 'å¤œ', romaji: 'yoru', meaning: 'å¤œæ™š', row: 'ã‚„è¡Œ' },
            { id: 'r1', kana: 'ã‚‰', word: 'ã¨ã‚‰', kanji: 'è™', romaji: 'tora', meaning: 'è€è™', row: 'ã‚‰è¡Œ', note: 'å–å­—å°¾éŸ³' },
            { id: 'r2', kana: 'ã‚Š', word: 'ã¨ã‚Š', kanji: 'é³¥', romaji: 'tori', meaning: 'é³¥', row: 'ã‚‰è¡Œ', note: 'å–å­—å°¾éŸ³' },
            { id: 'r3', kana: 'ã‚‹', word: 'ãã‚‹ã¾', kanji: 'è»Š', romaji: 'kuruma', meaning: 'è»Šå­', row: 'ã‚‰è¡Œ', note: 'å–ä¸­é–“éŸ³' },
            { id: 'r4', kana: 'ã‚Œ', word: 'ã™ã¿ã‚Œ', kanji: 'è«', romaji: 'sumire', meaning: 'ç´«ç¾…è˜­', row: 'ã‚‰è¡Œ', note: 'å–å­—å°¾éŸ³' },
            { id: 'r5', kana: 'ã‚', word: 'ã—ã‚', kanji: 'åŸ', romaji: 'shiro', meaning: 'åŸå ¡', row: 'ã‚‰è¡Œ', note: 'å–å­—å°¾éŸ³' },
            { id: 'w1', kana: 'ã‚', word: 'ã‚ã«', kanji: 'é°', romaji: 'wani', meaning: 'é±·é­š', row: 'ã‚è¡Œãƒ»å…¶ä»–' },
            { id: 'w2', kana: 'ã‚’', word: 'ã‹ãŠã‚’ã‚ã‚‰ã„ã¾ã™', kanji: 'é¡”ã‚’æ´—ã„ã¾ã™', romaji: 'kao wo araimasu', meaning: 'æ´—è‡‰', row: 'ã‚è¡Œãƒ»å…¶ä»–', note: 'åŠ©è©ç”¨æ³•' },
            { id: 'w3', kana: 'ã‚“', word: 'ã»ã‚“', kanji: 'æœ¬', romaji: 'hon', meaning: 'æ›¸', row: 'ã‚è¡Œãƒ»å…¶ä»–', note: 'å–å­—å°¾éŸ³' },
        ];

        // --- ICONS Component (Inline SVG) ---
        const Icon = {
            props: ['name', 'size', 'filled'],
            template: `
                <svg v-if="name === 'book'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                <svg v-else-if="name === 'layers'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                <svg v-else-if="name === 'graduation-cap'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>
                <svg v-else-if="name === 'rotate-ccw'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                <svg v-else-if="name === 'check'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                <svg v-else-if="name === 'x'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                <svg v-else-if="name === 'shuffle'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
                <svg v-else-if="name === 'arrow-left-right'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3 4 7l4 4"></path><path d="M4 7h16"></path><path d="M16 21l4-4-4-4"></path><path d="M20 17H4"></path></svg>
                <svg v-else-if="name === 'star'" :width="size||24" :height="size||24" viewBox="0 0 24 24" :fill="filled ? 'currentColor' : 'none'" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                <svg v-else-if="name === 'refresh-cw'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>
                <svg v-else-if="name === 'trophy'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 1 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>
                <svg v-else-if="name === 'settings'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                <svg v-else-if="name === 'play-circle'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>
                <svg v-else-if="name === 'chevron-left'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                <svg v-else-if="name === 'chevron-right'" :width="size||24" :height="size||24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
            `
        };

        const app = createApp({
            components: {
                'icon-book': { ...Icon, data() { return { name: 'book' } } },
                'icon-layers': { ...Icon, data() { return { name: 'layers' } } },
                'icon-graduation-cap': { ...Icon, data() { return { name: 'graduation-cap' } } },
                'icon-rotate-ccw': { ...Icon, data() { return { name: 'rotate-ccw' } } },
                'icon-check': { ...Icon, data() { return { name: 'check' } } },
                'icon-x': { ...Icon, data() { return { name: 'x' } } },
                'icon-shuffle': { ...Icon, data() { return { name: 'shuffle' } } },
                'icon-arrow-left-right': { ...Icon, data() { return { name: 'arrow-left-right' } } },
                'icon-star': { ...Icon, data() { return { name: 'star' } } },
                'icon-refresh-cw': { ...Icon, data() { return { name: 'refresh-cw' } } },
                'icon-trophy': { ...Icon, data() { return { name: 'trophy' } } },
                'icon-settings': { ...Icon, data() { return { name: 'settings' } } },
                'icon-play-circle': { ...Icon, data() { return { name: 'play-circle' } } },
                'icon-chevron-left': { ...Icon, data() { return { name: 'chevron-left' } } },
                'icon-chevron-right': { ...Icon, data() { return { name: 'chevron-right' } } },
            },
            setup() {
                const activeTab = ref('list');
                
                // --- FLASHCARD STATE ---
                const currentDeck = ref([]);
                const currentIndex = ref(0);
                const isFlipped = ref(false);
                const flashcardMode = ref('jp-zh');
                const memorizedIds = ref([]);
                const missedIds = ref([]);
                const bookmarks = ref([]);
                const roundComplete = ref(false);

                // --- QUIZ STATE ---
                const quizPhase = ref('setup');
                const quizConfig = ref({ mode: 'jp-zh', count: 10, source: 'all' });
                const quizState = ref({
                    score: 0,
                    currentQIndex: 0,
                    options: [],
                    lastCorrect: null,
                    questions: []
                });

                // Computed
                const groupedData = computed(() => {
                    return vocabularyData.reduce((acc, item) => {
                        if (!acc[item.row]) acc[item.row] = [];
                        acc[item.row].push(item);
                        return acc;
                    }, {});
                });

                const currentItem = computed(() => currentDeck.value[currentIndex.value] || {});
                const currentQuizItem = computed(() => quizState.value.questions[quizState.value.currentQIndex] || {});
                const sessionLearnedCount = computed(() => memorizedIds.value.length);
                const quizPercentage = computed(() => Math.round((quizState.value.score / quizState.value.questions.length) * 100) || 0);

                // Load Data
                onMounted(() => {
                    try {
                        const savedBookmarks = localStorage.getItem('jp_app_bookmarks');
                        if (savedBookmarks) bookmarks.value = JSON.parse(savedBookmarks);
                        const savedMissed = localStorage.getItem('jp_app_missed');
                        if (savedMissed) missedIds.value = JSON.parse(savedMissed);
                    } catch(e) { console.error(e); }
                    
                    // Keyboard Support
                    window.addEventListener('keydown', handleKeydown);
                });

                onUnmounted(() => {
                    window.removeEventListener('keydown', handleKeydown);
                });

                // Watchers
                watch(bookmarks, (newVal) => localStorage.setItem('jp_app_bookmarks', JSON.stringify(newVal)), { deep: true });
                watch(missedIds, (newVal) => localStorage.setItem('jp_app_missed', JSON.stringify(newVal)), { deep: true });

                // --- METHODS ---
                const handleKeydown = (e) => {
                    if (activeTab.value === 'flashcards' && !roundComplete.value && currentDeck.value.length > 0) {
                        if (e.code === 'Space') {
                            e.preventDefault();
                            isFlipped.value = !isFlipped.value;
                        } else if (e.code === 'ArrowUp') {
                            e.preventDefault();
                            prevCard(); // Desktop Nav Up = Prev
                        } else if (e.code === 'ArrowDown') {
                            e.preventDefault();
                            nextCard(); // Desktop Nav Down = Next
                        } else if (e.code === 'ArrowLeft') {
                            e.preventDefault();
                            handleCardResult('missed'); // Desktop Grading Left = Missed
                        } else if (e.code === 'ArrowRight') {
                            e.preventDefault();
                            handleCardResult('memorized'); // Desktop Grading Right = Memorized
                        }
                    }
                };

                const setActiveTab = (tab) => {
                    activeTab.value = tab;
                };

                const startSession = (type) => {
                    let deck = [];
                    if (type === 'all') deck = [...vocabularyData];
                    else if (type === 'bookmarks') deck = vocabularyData.filter(item => bookmarks.value.includes(item.id));
                    else if (type === 'missed') deck = vocabularyData.filter(item => missedIds.value.includes(item.id));

                    if (deck.length === 0) return;

                    currentDeck.value = deck;
                    currentIndex.value = 0;
                    isFlipped.value = false;
                    roundComplete.value = false;
                    memorizedIds.value = []; 
                    activeTab.value = 'flashcards';
                };

                const shuffleDeck = () => {
                    const shuffled = [...currentDeck.value].sort(() => 0.5 - Math.random());
                    currentDeck.value = shuffled;
                    currentIndex.value = 0;
                    isFlipped.value = false;
                };

                const handleCardResult = (result) => {
                    const currentCard = currentDeck.value[currentIndex.value];
                    if (result === 'memorized') {
                        if (!memorizedIds.value.includes(currentCard.id)) memorizedIds.value.push(currentCard.id);
                        if (missedIds.value.includes(currentCard.id)) {
                            missedIds.value = missedIds.value.filter(id => id !== currentCard.id);
                        }
                    } else {
                        if (!missedIds.value.includes(currentCard.id)) missedIds.value.push(currentCard.id);
                    }

                    if (currentIndex.value < currentDeck.value.length - 1) {
                        isFlipped.value = false;
                        setTimeout(() => currentIndex.value++, 150);
                    } else {
                        roundComplete.value = true;
                    }
                };

                const nextCard = () => {
                    if (currentIndex.value < currentDeck.value.length - 1) {
                        isFlipped.value = false;
                        currentIndex.value++;
                    }
                };

                const prevCard = () => {
                    if (currentIndex.value > 0) {
                        isFlipped.value = false;
                        currentIndex.value--;
                    }
                };

                const toggleBookmark = (id) => {
                    if (bookmarks.value.includes(id)) {
                        bookmarks.value = bookmarks.value.filter(bid => bid !== id);
                    } else {
                        bookmarks.value.push(id);
                    }
                };

                const hasBookmark = (id) => bookmarks.value.includes(id);

                const toggleFlashcardMode = () => {
                    flashcardMode.value = flashcardMode.value === 'jp-zh' ? 'zh-jp' : 'jp-zh';
                };

                // --- Touch Logic ---
                const touchStartX = ref(null);
                const touchCurrentX = ref(null); // Track for visual feedback
                
                const onTouchStart = (e) => { 
                    touchStartX.value = e.targetTouches[0].clientX; 
                    touchCurrentX.value = touchStartX.value;
                };
                
                const onTouchMove = (e) => {
                    touchCurrentX.value = e.targetTouches[0].clientX;
                };

                const onTouchEnd = (e) => {
                    if (!touchStartX.value) return;
                    const endX = e.changedTouches[0].clientX;
                    const diff = touchStartX.value - endX; // Positive = Swipe Left, Negative = Swipe Right
                    
                    // Logic: Swipe Left -> Next Card (or Missed?)
                    // User requested: 
                    // Right Swipe (Finger moves Left to Right, diff negative) -> Memorized
                    // Left Swipe (Finger moves Right to Left, diff positive) -> Missed
                    
                    if (diff < -50) { 
                        // Swipe Right (Memorized)
                        handleCardResult('memorized');
                    } else if (diff > 50) { 
                        // Swipe Left (Missed)
                        handleCardResult('missed');
                    }
                    
                    touchStartX.value = null;
                    touchCurrentX.value = null;
                };

                // --- Quiz Logic ---
                const startQuiz = () => {
                    let pool = [];
                    
                    // Filter by Source
                    if (quizConfig.value.source === 'bookmarks') {
                        pool = vocabularyData.filter(item => bookmarks.value.includes(item.id));
                    } else if (quizConfig.value.source === 'missed') {
                        pool = vocabularyData.filter(item => missedIds.value.includes(item.id));
                    } else {
                        pool = [...vocabularyData];
                    }

                    // Shuffle
                    pool = pool.sort(() => 0.5 - Math.random());

                    // Filter by Count
                    if (quizConfig.value.count !== 'all') {
                        pool = pool.slice(0, quizConfig.value.count);
                    }
                    
                    if (pool.length === 0) {
                        alert('é¸å®šçš„ç¯„åœæ²’æœ‰é¡Œç›®ï¼');
                        return;
                    }

                    quizState.value = {
                        questions: pool,
                        currentQIndex: 0,
                        score: 0,
                        lastCorrect: null,
                        options: generateOptions(pool[0])
                    };
                    quizPhase.value = 'playing';
                };

                const generateOptions = (correctItem) => {
                    const incorrect = vocabularyData.filter(item => item.id !== correctItem.id)
                        .sort(() => 0.5 - Math.random()).slice(0, 3);
                    return [correctItem, ...incorrect].sort(() => 0.5 - Math.random());
                };

                const handleQuizAnswer = (selectedOption) => {
                    if (quizState.value.lastCorrect !== null) return;
                    
                    const currentQ = quizState.value.questions[quizState.value.currentQIndex];
                    let isCorrect = quizConfig.value.mode === 'jp-zh' 
                        ? selectedOption.meaning === currentQ.meaning 
                        : selectedOption.word === currentQ.word;

                    quizState.value.lastCorrect = isCorrect;
                    if (isCorrect) {
                        quizState.value.score++;
                        if (missedIds.value.includes(currentQ.id)) {
                             missedIds.value = missedIds.value.filter(id => id !== currentQ.id);
                        }
                    } else {
                        if (!missedIds.value.includes(currentQ.id)) missedIds.value.push(currentQ.id);
                    }

                    setTimeout(() => {
                        if (quizState.value.currentQIndex + 1 < quizState.value.questions.length) {
                            quizState.value.currentQIndex++;
                            quizState.value.lastCorrect = null;
                            quizState.value.options = generateOptions(quizState.value.questions[quizState.value.currentQIndex]);
                        } else {
                            quizPhase.value = 'result';
                        }
                    }, 1000);
                };

                const getQuizOptionClass = (opt) => {
                    if (quizState.value.lastCorrect === null) return 'bg-white border-slate-100 active:bg-indigo-50 hover:border-indigo-200';
                    
                    const currentQ = quizState.value.questions[quizState.value.currentQIndex];
                    const isCorrect = quizConfig.value.mode === 'jp-zh' 
                        ? opt.meaning === currentQ.meaning 
                        : opt.word === currentQ.word;

                    if (isCorrect) return 'border-green-500 bg-green-50 text-green-700';
                    if (quizState.value.lastCorrect === false && !isCorrect) return 'opacity-40 border-slate-100';
                    return 'bg-white border-slate-100';
                };

                return {
                    vocabularyData, activeTab, setActiveTab,
                    // Flashcard
                    currentDeck, currentIndex, isFlipped, flashcardMode, currentItem, 
                    memorizedIds, missedIds, bookmarks, roundComplete, sessionLearnedCount,
                    startSession, shuffleDeck, handleCardResult, toggleBookmark, hasBookmark, toggleFlashcardMode,
                    nextCard, prevCard,
                    onTouchStart, onTouchMove, onTouchEnd, touchStartX, touchCurrentX,
                    // List
                    groupedData,
                    // Quiz
                    quizPhase, quizConfig, quizState, currentQuizItem, quizPercentage,
                    startQuiz, handleQuizAnswer, getQuizOptionClass
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
