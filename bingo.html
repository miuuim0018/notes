<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Bingo (Auto-Detect)</title>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --accent: #f1c40f; /* Gold for win */
            --delete: #e74c3c;
            --bg: #f4f6f7;
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; color: var(--secondary);
        }

        h1 { margin: 0 0 10px 0; text-align: center; }

        .container {
            width: 100%; max-width: 500px; background: white;
            padding: 20px; border-radius: var(--radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .hidden { display: none !important; }

        /* BUTTONS */
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: bold; cursor: pointer; margin-bottom: 10px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-host { background: #8e44ad; color: white; }
        .btn-outline { background: transparent; border: 2px solid #bdc3c7; color: #7f8c8d; }
        
        /* SETUP INPUT */
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="number"] {
            width: 100%; padding: 10px; font-size: 1.2rem; text-align: center;
            border: 2px solid #ddd; border-radius: 8px;
        }

        /* GRID SYSTEM */
        .bingo-grid {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 6px; margin: 15px 0;
        }

        .cell {
            aspect-ratio: 1; background: #ecf0f1; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; font-weight: bold; color: #95a5a6;
            cursor: pointer; user-select: none; position: relative;
            transition: background 0.2s, color 0.2s;
        }

        /* Selection Mode States */
        .cell.filled { background: white; border: 2px solid var(--primary); color: var(--primary); }

        /* Game Mode States */
        .cell.game-mode { border: 2px solid transparent; background: white; color: var(--secondary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* MARKED (Red X) */
        .cell.game-mode.marked {
            background: #ff7675; color: white;
        }
        .cell.game-mode.marked::after {
            content: 'âœ•'; position: absolute; font-size: 1.5rem; opacity: 0.6;
        }

        /* WINNING LINE (Gold) */
        .cell.game-mode.win {
            background: var(--accent) !important;
            color: #d35400 !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* GAME STATS BAR */
        .stats-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: #2c3e50; color: white; padding: 10px 15px;
            border-radius: 8px; margin-bottom: 15px;
        }
        .line-count {
            background: var(--accent); color: #d35400; padding: 2px 8px;
            border-radius: 4px; font-weight: bold;
        }

        /* POPUP PICKER */
        #picker-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 900;
            display: flex; align-items: end; justify-content: center;
        }
        .picker-content {
            background: white; width: 100%; max-width: 500px;
            border-radius: 20px 20px 0 0; padding: 20px;
            max-height: 80vh; display: flex; flex-direction: column;
        }
        .number-pad {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
            overflow-y: auto; padding-bottom: 20px;
        }
        .num-btn {
            aspect-ratio: 1.2; background: white; border: 1px solid #ddd;
            border-radius: 6px; font-size: 1rem; font-weight: bold;
        }
        .num-btn.used { background: #eee; color: #ccc; pointer-events: none; }

        /* BINGO CELEBRATION MODAL */
        #bingo-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--accent);
        }
        .bingo-text { font-size: 5rem; font-weight: 900; text-shadow: 0 0 20px gold; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* HOST STYLES */
        .host-draw {
            font-size: 5rem; font-weight: 800; color: #8e44ad;
            text-align: center; padding: 20px; background: #f3e5f5;
            border-radius: var(--radius); margin-bottom: 20px;
        }
        .history-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; }
        .hist-dot {
            aspect-ratio: 1; background: #eee; font-size: 0.8rem;
            display: flex; align-items: center; justify-content: center; border-radius: 4px;
        }
        .hist-dot.active { background: #8e44ad; color: white; }

    </style>
</head>
<body>

    <h1>Smart Bingo ğŸ‘‘</h1>

    <div id="setup-panel" class="container">
        <div class="input-group">
            <label>æœ€å¤§æ•¸å­— (Max Number)</label>
            <input type="number" id="max-num-input" value="50" min="25" max="99">
        </div>
        <button class="btn btn-host" onclick="initHost()">æˆ‘æ˜¯ä¸»æŒäºº</button>
        <button class="btn btn-primary" onclick="initPlayer()">æˆ‘æ˜¯ç©å®¶</button>
    </div>

    <div id="player-select" class="container hidden">
        <p style="text-align:center; color:#7f8c8d; margin-top:0;">é»æ“Šæ ¼å­é¸æ“‡æ•¸å­—</p>
        <div class="bingo-grid" id="select-grid"></div>
        
        <div style="display:flex; justify-content:space-between; gap:10px;">
            <button class="btn btn-outline" onclick="randomFillRemaining()">ğŸ² éš¨æ©Ÿè£œæ»¿</button>
            <button class="btn btn-outline" onclick="resetCard()">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        
        <button id="lock-btn" class="btn btn-primary" style="margin-top:15px; opacity:0.5;" onclick="startGame()" disabled>
            ğŸ”’ é–å®šä¸¦é–‹å§‹
        </button>
        <button class="btn btn-outline" style="margin-top:10px; border:none;" onclick="location.reload()">å›é¦–é </button>
    </div>

    <div id="player-game" class="container hidden">
        <div class="stats-bar">
            <span>è³“æœé€£ç·šæ•¸</span>
            <span id="line-counter" class="line-count">0</span>
        </div>
        
        <div class="bingo-grid" id="game-grid"></div>
        
        <p style="text-align:center; font-size:0.9rem; color:#95a5a6;">
            é»æ“Šæ¨™è¨˜ï¼Œé€£ç·šæœƒè‡ªå‹•ç™¼å…‰ âœ¨
        </p>
        <button class="btn btn-outline" onclick="if(confirm('ç¢ºå®šè¦é€€å‡ºå—ï¼Ÿ')) location.reload()">é€€å‡ºéŠæˆ²</button>
    </div>

    <div id="host-panel" class="container hidden">
        <h2 style="color:#8e44ad; margin-top:0;">ä¸»æŒäºº</h2>
        <div class="host-draw" id="host-display">Ready</div>
        <button class="btn btn-host" onclick="drawNumber()">æŠ½å‡ºè™Ÿç¢¼</button>
        <div style="margin-top:20px;">
            <p>æ­·å²ç´€éŒ„:</p>
            <div class="history-grid" id="host-history"></div>
        </div>
        <button class="btn btn-outline" style="margin-top:20px;" onclick="location.reload()">çµæŸ</button>
    </div>

    <div id="picker-overlay" class="hidden" onclick="if(event.target.id==='picker-overlay') this.classList.add('hidden')">
        <div class="picker-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span style="font-weight:bold; font-size:1.2rem;">é¸æ“‡æ•¸å­—</span>
                <button onclick="document.getElementById('picker-overlay').classList.add('hidden')" style="border:none; bg:none; font-size:1.5rem;">&times;</button>
            </div>
            <div class="number-pad" id="number-pad"></div>
            <button class="btn btn-outline" style="margin-top:10px; color:#e74c3c; border-color:#e74c3c;" onclick="clearCurrentCell()">æ¸…é™¤æ­¤æ ¼</button>
        </div>
    </div>

    <div id="bingo-modal" class="hidden" onclick="this.classList.add('hidden')">
        <div class="bingo-text">BINGO!</div>
        <p style="color:white; margin-top:20px;">é»æ“Šç•«é¢ç¹¼çºŒ</p>
    </div>

    <script>
        // GLOBAL
        let maxNumber = 50;
        let cardData = new Array(25).fill(null);
        let markedState = new Array(25).fill(false); // New: Track marks
        let currentEditingIndex = -1;
        let hasBingoed = false; // To show animation only once (optional)

        // --- SETUP ---
        function initHost() {
            if(!validateSetup()) return;
            switchScreen('host-panel');
            renderHistoryBoard();
        }

        function initPlayer() {
            if(!validateSetup()) return;
            switchScreen('player-select');
            renderSelectGrid();
        }

        function validateSetup() {
            const val = parseInt(document.getElementById('max-num-input').value);
            if(val < 25) { alert("æ•¸å­—è‡³å°‘è¦ 25 å€‹ï¼"); return false; }
            maxNumber = val;
            return true;
        }

        function switchScreen(id) {
            document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('setup-panel').classList.add('hidden');
        }

        // --- SELECTION LOGIC ---
        function renderSelectGrid() {
            const grid = document.getElementById('select-grid');
            grid.innerHTML = '';
            cardData.forEach((num, index) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                if(num) { cell.innerText = num; cell.classList.add('filled'); }
                cell.onclick = () => openPicker(index);
                grid.appendChild(cell);
            });
            checkLock();
        }

        function openPicker(index) {
            currentEditingIndex = index;
            const pad = document.getElementById('number-pad');
            pad.innerHTML = '';
            document.getElementById('picker-overlay').classList.remove('hidden');

            for(let i=1; i<=maxNumber; i++) {
                const btn = document.createElement('button');
                btn.className = 'num-btn';
                btn.innerText = i;
                if(cardData.includes(i) && cardData[index] !== i) btn.classList.add('used');
                btn.onclick = () => {
                    cardData[index] = i;
                    document.getElementById('picker-overlay').classList.add('hidden');
                    renderSelectGrid();
                };
                pad.appendChild(btn);
            }
        }

        function clearCurrentCell() {
            cardData[currentEditingIndex] = null;
            document.getElementById('picker-overlay').classList.add('hidden');
            renderSelectGrid();
        }

        function randomFillRemaining() {
            let available = [];
            for(let i=1; i<=maxNumber; i++) if(!cardData.includes(i)) available.push(i);
            // Shuffle
            for(let i = available.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [available[i], available[j]] = [available[j], available[i]];
            }
            let ptr = 0;
            for(let i=0; i<25; i++) if(cardData[i] === null && ptr < available.length) cardData[i] = available[ptr++];
            renderSelectGrid();
        }

        function resetCard() {
            if(confirm('æ¸…ç©ºå¡ç‰‡ï¼Ÿ')) { cardData.fill(null); renderSelectGrid(); }
        }

        function checkLock() {
            const filled = cardData.filter(n => n).length;
            const btn = document.getElementById('lock-btn');
            btn.disabled = filled !== 25;
            btn.style.opacity = filled === 25 ? 1 : 0.5;
        }

        // --- GAME LOGIC (SMART RECOGNITION) ---
        function startGame() {
            if(!confirm("ç¢ºå®šé–å®šï¼Ÿ")) return;
            switchScreen('player-game');
            renderGameGrid();
        }

        function renderGameGrid() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = '';
            cardData.forEach((num, index) => {
                const cell = document.createElement('div');
                cell.className = 'cell game-mode';
                cell.id = `gc-${index}`; // Add ID for line highlighting
                cell.innerText = num;
                cell.onclick = () => toggleMark(index);
                grid.appendChild(cell);
            });
        }

        function toggleMark(index) {
            markedState[index] = !markedState[index];
            const cell = document.getElementById(`gc-${index}`);
            
            if(markedState[index]) cell.classList.add('marked');
            else cell.classList.remove('marked');

            checkWin(); // Trigger recognition
        }

        function checkWin() {
            // Reset visual wins
            document.querySelectorAll('.cell.game-mode').forEach(c => c.classList.remove('win'));
            
            let lines = 0;
            let winningIndices = new Set();

            // Rows
            for(let r=0; r<5; r++) {
                let rowIndices = [];
                let full = true;
                for(let c=0; c<5; c++) {
                    let idx = r*5 + c;
                    rowIndices.push(idx);
                    if(!markedState[idx]) full = false;
                }
                if(full) {
                    lines++;
                    rowIndices.forEach(idx => winningIndices.add(idx));
                }
            }

            // Cols
            for(let c=0; c<5; c++) {
                let colIndices = [];
                let full = true;
                for(let r=0; r<5; r++) {
                    let idx = r*5 + c;
                    colIndices.push(idx);
                    if(!markedState[idx]) full = false;
                }
                if(full) {
                    lines++;
                    colIndices.forEach(idx => winningIndices.add(idx));
                }
            }

            // Diagonals
            const d1 = [0, 6, 12, 18, 24];
            if(d1.every(idx => markedState[idx])) {
                lines++;
                d1.forEach(idx => winningIndices.add(idx));
            }

            const d2 = [4, 8, 12, 16, 20];
            if(d2.every(idx => markedState[idx])) {
                lines++;
                d2.forEach(idx => winningIndices.add(idx));
            }

            // Update UI
            document.getElementById('line-counter').innerText = lines;
            winningIndices.forEach(idx => {
                document.getElementById(`gc-${idx}`).classList.add('win');
            });

            // Trigger Bingo Animation (First time getting > 0 lines)
            if(lines > 0 && !hasBingoed) {
                document.getElementById('bingo-modal').classList.remove('hidden');
                hasBingoed = true; // prevent spamming
            }
        }

        // --- HOST LOGIC ---
        let hostDrawn = [];
        let isAnimating = false;

        function renderHistoryBoard() {
            const board = document.getElementById('host-history');
            board.innerHTML = '';
            board.style.gridTemplateColumns = `repeat(${Math.ceil(Math.sqrt(maxNumber))}, 1fr)`;
            for(let i=1; i<=maxNumber; i++) {
                const d = document.createElement('div');
                d.className = 'hist-dot'; d.id = `h-${i}`; d.innerText = i;
                board.appendChild(d);
            }
        }

        function drawNumber() {
            if(isAnimating) return;
            if(hostDrawn.length >= maxNumber) { alert('çµæŸ'); return; }
            isAnimating = true;
            const disp = document.getElementById('host-display');
            let c=0;
            const t = setInterval(() => {
                disp.innerText = Math.floor(Math.random()*maxNumber)+1;
                c++;
                if(c>10) { clearInterval(t); finalizeDraw(); }
            }, 50);
        }

        function finalizeDraw() {
            let n;
            do { n = Math.floor(Math.random()*maxNumber)+1; } while(hostDrawn.includes(n));
            hostDrawn.push(n);
            document.getElementById('host-display').innerText = n;
            document.getElementById(`h-${n}`).classList.add('active');
            isAnimating = false;
        }
    </script>
</body>
</html>
