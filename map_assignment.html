<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>⚡️ CHIAYI REGION DRINKS CYBER-MAP V6.0 ⚡️</title>
    
    <!-- 引入 Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #bc13fe;
            --neon-green: #0aff0a;
            --neon-yellow: #ffe600;
            --neon-magenta: #ff00ff;
            --neon-orange: #ffa500;
            --glass-bg: rgba(10, 15, 25, 0.9);
            --border-color: rgba(0, 243, 255, 0.4);
        }

        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Orbitron', 'Noto Sans TC', sans-serif;
            background-color: #0b0c10;
            color: #fff;
            overflow: hidden;
        }

        #map {
            height: 100vh; 
            width: 100%;
            z-index: 1;
            background: #0b0c10;
        }

        /* --- UI 通用樣式 (毛玻璃 + 掃描線) --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 4px; /* 改成更方正的科技感 */
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.15), inset 0 0 20px rgba(0, 0, 0, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* 掃描線特效 */
        .glass-panel::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* --- 1. 左上標題區 --- */
        .title-box {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            padding: 15px 25px;
            border-left: 4px solid var(--neon-blue);
            clip-path: polygon(0 0, 100% 0, 100% 85%, 90% 100%, 0 100%); /* 切角設計 */
            pointer-events: none;
        }
        .title-box * { pointer-events: auto; }

        .title-box h1 {
            margin: 0;
            font-size: 1.8rem;
            letter-spacing: 2px;
            color: var(--neon-blue);
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        .title-box p {
            margin: 5px 0 0 0;
            font-size: 0.8rem;
            color: #aaa;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* --- 2. 頂部搜尋列 --- */
        .search-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 320px;
            display: flex;
            align-items: center;
            border-bottom: 2px solid var(--neon-blue);
        }

        .search-box input {
            width: 100%;
            background: transparent;
            border: none;
            padding: 12px 20px;
            color: #fff;
            font-family: 'Orbitron', 'Noto Sans TC';
            font-size: 1rem;
            outline: none;
            letter-spacing: 1px;
        }
        .search-icon {
            padding-right: 15px;
            color: var(--neon-blue);
            font-size: 1.2rem;
            animation: blink 2s infinite;
        }

        /* --- 3. 右下控制面板 (戰術中心) --- */
        .chart-panel {
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            width: 360px; /* 加寬一點 */
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }

        /* 面板標頭與按鈕 */
        #toggleBtn {
            width: 100%;
            background: rgba(0, 243, 255, 0.1);
            border: none;
            border-bottom: 1px solid var(--border-color);
            color: var(--neon-blue);
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            cursor: pointer;
            padding: 12px;
            font-size: 0.9rem;
            letter-spacing: 3px;
            outline: none;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #toggleBtn:hover { background: rgba(0, 243, 255, 0.2); }
        .status-light {
            width: 8px; height: 8px; background: var(--neon-green);
            border-radius: 50%; box-shadow: 0 0 5px var(--neon-green);
            display: inline-block; margin-right: 10px;
        }

        /* HUD 數據顯示 */
        .hud-stats {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3);
            font-size: 0.8rem;
        }
        .hud-item { text-align: center; }
        .hud-val { display: block; font-size: 1.2rem; color: var(--neon-yellow); font-weight: bold; }
        .hud-label { color: #888; font-size: 0.6rem; }

        .chart-content {
            padding: 15px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--neon-blue) transparent;
        }
        .chart-content::-webkit-scrollbar { width: 4px; }
        .chart-content::-webkit-scrollbar-thumb { background-color: var(--neon-blue); }

        .chart-panel h3 {
            margin-top: 20px;
            font-size: 0.85rem;
            color: var(--neon-pink);
            text-align: left;
            padding-left: 10px;
            border-left: 3px solid var(--neon-pink);
            background: linear-gradient(90deg, rgba(188, 19, 254, 0.1), transparent);
            padding-top: 5px; padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .chart-panel h3:first-child { margin-top: 0; }

        /* 系統日誌 - 終端機風格 */
        .system-log {
            margin-top: 15px;
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            height: 120px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            color: var(--neon-green);
        }
        .log-entry { margin-bottom: 2px; }
        .log-entry::before { content: '> '; color: #555; }

        /* 面板收合 */
        .panel-collapsed .chart-content, .panel-collapsed .hud-stats { display: none; }
        .panel-collapsed { width: auto; min-width: 200px; }

        /* --- 4. 定位按鈕 --- */
        .locate-btn {
            position: absolute;
            bottom: 40px; left: 30px;
            z-index: 1000;
            width: 60px; height: 60px;
            border-radius: 50%;
            border: 2px solid var(--neon-blue);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            color: var(--neon-blue); font-size: 2rem;
            background: rgba(0,0,0,0.6);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
            transition: 0.3s;
        }
        .locate-btn:hover { box-shadow: 0 0 30px var(--neon-blue); transform: rotate(90deg); }

        /* --- 呼吸燈標記 --- */
        .glowing-dot {
            width: 14px; height: 14px;
            background-color: currentColor;
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
            position: relative;
        }
        .glowing-dot::after {
            content: ''; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid currentColor;
            animation: pulse-ring 2s ease-out infinite;
        }
        @keyframes pulse-ring {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Popup 優化 */
        .leaflet-popup-content-wrapper {
            background: rgba(10, 15, 25, 0.95) !important;
            border: 1px solid var(--neon-blue);
            border-radius: 0 !important;
            color: #fff !important;
        }
        .leaflet-popup-tip { background: var(--neon-blue) !important; }
        .nav-btn {
            display: block; margin-top: 10px;
            background: var(--neon-blue); color: #000;
            text-align: center; padding: 8px;
            font-weight: bold; text-decoration: none;
            clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
        }
        .nav-btn:hover { background: #fff; }

        /* RWD */
        @media (max-width: 600px) {
            .title-box { display: none; }
            .search-box { width: 85%; top: 15px; }
            .chart-panel { width: 90%; right: 5%; bottom: 100px; max-height: 50vh; }
            .locate-btn { bottom: 20px; left: 20px; }
            .panel-collapsed { bottom: 20px; right: 20px; width: auto; }
        }
    </style>
</head>
<body>

    <!-- 標題 -->
    <div class="title-box glass-panel">
        <h1>CHIAYI REGION<br>TACTICAL MAP</h1>
        <p>V6.0 // 戰術指揮系統 // 連線中</p>
    </div>

    <!-- 搜尋 -->
    <div class="search-box glass-panel">
        <input type="text" id="searchInput" placeholder="SEARCH TARGET..." onkeyup="filterMarkers()">
        <div class="search-icon">⌖</div>
    </div>

    <!-- 定位 -->
    <div class="locate-btn" onclick="locateUser()" title="GPS Sync">⊕</div>

    <!-- 戰術控制面板 -->
    <div class="chart-panel glass-panel" id="statsPanel">
        <button id="toggleBtn" onclick="togglePanel()">
            <span><span class="status-light"></span>TACTICAL HUD</span>
            <span id="toggleIcon">▼</span>
        </button>
        
        <!-- HUD 數據 -->
        <div class="hud-stats">
            <div class="hud-item">
                <span class="hud-val" id="totalTargets">0</span>
                <span class="hud-label">TARGETS</span>
            </div>
            <div class="hud-item">
                <span class="hud-val" id="activeBrands">0</span>
                <span class="hud-label">BRANDS</span>
            </div>
            <div class="hud-item">
                <span class="hud-val" style="color:var(--neon-pink)">LIVE</span>
                <span class="hud-label">STATUS</span>
            </div>
        </div>

        <div class="chart-content">
            <!-- 互動說明 -->
            <div style="font-size: 0.7rem; color: #888; margin-bottom: 10px; border: 1px solid #333; padding: 5px;">
                ⓘ TIP: CLICK BARS TO FILTER MAP
            </div>

            <h3>Distribution Analysis</h3>
            <canvas id="brandChart"></canvas>
            
            <h3>Strategic Radar</h3>
            <canvas id="radarChart"></canvas>
            
            <h3>Market Dominance</h3>
            <canvas id="shareChart"></canvas>
            
            <h3>System Terminal</h3>
            <div class="system-log" id="systemLog">
                <div class="log-entry">Initializing V6.0 Core...</div>
                <div class="log-entry">Loading topographic data...</div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // --- 設定與資料 ---
        const brandColors = {
            "50嵐": "#ffe600", "迷客夏": "#00ff88", "可不可": "#ff4d4d",
            "清心福全": "#00d2ff", "麻古茶坊": "#ff00dd", "大苑子": "#55ff00",
            "五桐號": "#ffaa00", "得正": "#00aaff", "龜記": "#ff5500",
            "八曜和茶": "#ccff00", "茶之魔手": "#ff0000", "御香屋": "#ffcc00",
            "鮮茶道": "#ff00ff", "Tea's 原味": "#ffa500", "茶湯會": "#d2b48c",
            "其他": "#ffffff"
        };

        // 模擬與真實混合資料
        let shopsData = [
            { name: "源興御香屋", brand: "御香屋", lat: 23.4800, lng: 120.4490, note: "嘉義市 - 傳奇" },
            { name: "源興御香屋 中正二店", brand: "御香屋", lat: 23.4795, lng: 120.4505, note: "嘉義市" },
            // ... (為節省長度，這裡應包含之前的完整資料，實際執行時請使用V5的完整陣列)
        ];
        
        // 為了確保範例完整，這裡補回部分 V5 的資料作為演示 (實際使用時請保留 V5 完整資料)
        const demoData = [
             { name: "50嵐 民雄建國店", brand: "50嵐", lat: 23.5532, lng: 120.4295, note: "民雄" },
             { name: "麻古茶坊 民雄店", brand: "麻古茶坊", lat: 23.5528, lng: 120.4310, note: "民雄" },
             { name: "迷客夏 嘉義林森店", brand: "迷客夏", lat: 23.4845, lng: 120.4480, note: "嘉義市" },
             { name: "茶之魔手 朴子店", brand: "茶之魔手", lat: 23.4670, lng: 120.2460, note: "朴子" },
             { name: "得正 嘉義中山店", brand: "得正", lat: 23.4793, lng: 120.4458, note: "嘉義市" },
             { name: "八曜和茶 嘉義店", brand: "八曜和茶", lat: 23.4789, lng: 120.4462, note: "嘉義市" },
             { name: "鮮茶道 太保店", brand: "鮮茶道", lat: 23.4549, lng: 120.2950, note: "太保" }
        ];
        // 簡單合併演示用，實際上請保留 V5 的完整 shopsData + osmData
        shopsData = shopsData.concat(demoData);


        let allMarkers = [];
        let userMarker = null;
        let userLatLng = null;
        let currentFilterBrand = null; // 用於儲存當前過濾狀態

        // --- 初始化地圖 ---
        const map = L.map('map', { zoomControl: false }).setView([23.4800, 120.4490], 13);
        L.control.zoom({ position: 'topright' }).addTo(map);

        const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', maxZoom: 20
        }).addTo(map);

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri', maxZoom: 17
        });

        // --- 建立標記 ---
        const layers = {};
        const brandCounts = {};

        function getPopupContent(shop) {
            let distInfo = userLatLng 
                ? `<div style="color:var(--neon-yellow); margin-top:5px;">RANGE: ${(map.distance(userLatLng, [shop.lat, shop.lng])/1000).toFixed(1)} KM</div>`
                : `<div style="color:#666; margin-top:5px;">NO GPS SIGNAL</div>`;
            
            return `
                <div style="font-family:'Orbitron'; font-size:0.7rem; color:#888;">TARGET ID: ${Math.floor(Math.random()*9999)}</div>
                <b style="color: ${brandColors[shop.brand] || '#fff'}; font-size:1.1rem;">${shop.name}</b><br>
                <span style="font-size:0.8rem; color:#aaa;">${shop.note || "NO INTEL"}</span>
                ${distInfo}
                <a href="https://www.google.com/maps/dir/?api=1&destination=${shop.lat},${shop.lng}" target="_blank" class="nav-btn">INITIATE ROUTE</a>
            `;
        }

        shopsData.forEach(shop => {
            let bName = shop.brand.includes("Tea's") ? "Tea's 原味" : shop.brand;
            if(!brandColors[bName]) bName = "其他";
            shop.brand = bName;

            brandCounts[bName] = (brandCounts[bName] || 0) + 1;
            const myColor = brandColors[bName] || "#fff";

            const icon = L.divIcon({
                className: 'custom-pin',
                html: `<div class="glowing-dot" style="color: ${myColor}; transform: scale(${bName === "御香屋" ? 1.5 : 1});"></div>`,
                iconSize: [20, 20], iconAnchor: [10, 10], popupAnchor: [0, -10]
            });

            const marker = L.marker([shop.lat, shop.lng], { icon: icon }).bindPopup(() => getPopupContent(shop));
            
            marker.on('click', () => logAction(`Target selected: ${shop.name}`));

            if (!layers[bName]) layers[bName] = L.layerGroup();
            layers[bName].addLayer(marker);
            allMarkers.push({ marker: marker, data: shop });
        });

        for (let key in layers) layers[key].addTo(map);
        L.control.layers({ "Cyber Mode": darkLayer, "Satellite": satelliteLayer }, layers, { collapsed: true }).addTo(map);

        // --- HUD 數據更新特效 ---
        function animateValue(id, start, end, duration) {
            let obj = document.getElementById(id);
            let range = end - start;
            let minTimer = 50;
            let stepTime = Math.abs(Math.floor(duration / range));
            stepTime = Math.max(stepTime, minTimer);
            let startTime = new Date().getTime();
            let endTime = startTime + duration;
            let timer;
            function run() {
                let now = new Date().getTime();
                let remaining = Math.max((endTime - now) / duration, 0);
                let value = Math.round(end - (remaining * range));
                obj.innerHTML = value;
                if (value == end) clearInterval(timer);
            }
            timer = setInterval(run, stepTime);
            run();
        }

        // --- 圖表設定 ---
        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = 'rgba(0, 243, 255, 0.1)';
        Chart.defaults.font.family = "'Orbitron', sans-serif";

        const labels = Object.keys(brandCounts);
        const dataValues = Object.values(brandCounts);
        const bgColors = labels.map(l => brandColors[l] || '#fff');

        // 1. 長條圖 (Distribution) - 含點擊互動
        const ctxBar = document.getElementById('brandChart').getContext('2d');
        const brandChart = new Chart(ctxBar, {
            type: 'bar',
            data: { 
                labels: labels, 
                datasets: [{ 
                    label: 'Count', 
                    data: dataValues, 
                    backgroundColor: bgColors,
                    borderRadius: 2,
                    barPercentage: 0.6
                }] 
            },
            options: {
                responsive: true,
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const selectedBrand = labels[index];
                        toggleMapFilter(selectedBrand);
                    } else {
                        // 點擊空白處重置
                        resetMapFilter();
                    }
                },
                scales: { 
                    x: { ticks: { display: false } }, // 隱藏 X 軸標籤避免擁擠
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } } 
                },
                plugins: { legend: { display: false } }
            }
        });

        // 2. 雷達圖 (Radar) - 模擬戰術屬性
        // 我們隨機產生一些 "戰術數據" 讓圖表看起來很酷
        const ctxRadar = document.getElementById('radarChart').getContext('2d');
        new Chart(ctxRadar, {
            type: 'radar',
            data: {
                labels: ['Density', 'Price', 'Sugar', 'Queue', 'Hype'],
                datasets: [{
                    label: 'Area Avg',
                    data: [80, 65, 90, 50, 70],
                    borderColor: 'rgba(0, 243, 255, 0.8)',
                    backgroundColor: 'rgba(0, 243, 255, 0.2)',
                    borderWidth: 2,
                    pointBackgroundColor: '#fff'
                }, {
                    label: 'Target Max',
                    data: [100, 90, 100, 100, 95],
                    borderColor: 'rgba(188, 19, 254, 0.6)',
                    backgroundColor: 'transparent',
                    borderDash: [5, 5],
                    pointRadius: 0
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { color: 'rgba(255,255,255,0.1)' },
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        pointLabels: { color: '#aaa', font: { size: 10 } },
                        ticks: { display: false }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        // 3. 圓餅圖 (Dominance)
        const ctxPie = document.getElementById('shareChart').getContext('2d');
        new Chart(ctxPie, {
            type: 'doughnut',
            data: { 
                labels: labels, 
                datasets: [{ 
                    data: dataValues, 
                    backgroundColor: bgColors, 
                    borderColor: '#10141e', 
                    borderWidth: 2 
                }] 
            },
            options: { 
                cutout: '70%', 
                plugins: { legend: { position: 'right', labels: { boxWidth: 8, font: { size: 9 }, color: '#aaa' } } } 
            }
        });

        // --- 核心功能 ---

        function toggleMapFilter(brand) {
            if (currentFilterBrand === brand) {
                resetMapFilter();
                return;
            }
            currentFilterBrand = brand;
            
            // 隱藏所有圖層
            for (let key in layers) {
                map.removeLayer(layers[key]);
            }
            // 只加入選中的
            if (layers[brand]) {
                map.addLayer(layers[brand]);
                // 飛到該品牌第一個點的附近
                const firstMarker = allMarkers.find(m => m.data.brand === brand);
                if(firstMarker) {
                    map.flyTo(firstMarker.marker.getLatLng(), 14);
                }
            }
            logAction(`FILTER APPLIED: ${brand}`);
        }

        function resetMapFilter() {
            currentFilterBrand = null;
            for (let key in layers) {
                if (!map.hasLayer(layers[key])) {
                    map.addLayer(layers[key]);
                }
            }
            logAction(`FILTER RESET: SHOW ALL`);
        }

        function filterMarkers() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            allMarkers.forEach(item => {
                const text = (item.data.name + item.data.brand + item.data.note).toLowerCase();
                // 如果目前有品牌過濾，這裡要配合邏輯 (暫時簡單處理：搜尋優先)
                if (text.includes(input)) {
                    item.marker.addTo(map);
                } else {
                    item.marker.remove();
                }
            });
        }

        function locateUser() {
            logAction("GPS SATELLITE SYNC...");
            map.locate({setView: true, maxZoom: 15});
            map.on('locationfound', e => {
                userLatLng = e.latlng;
                if(userMarker) userMarker.remove();
                userMarker = L.marker(e.latlng).addTo(map).bindPopup("YOU ARE HERE").openPopup();
                L.circle(e.latlng, {radius: e.accuracy, color: '#00f3ff'}).addTo(map);
                logAction("LOCATION CONFIRMED");
            });
        }

        function logAction(msg) {
            const logBox = document.getElementById('systemLog');
            const time = new Date().toLocaleTimeString('en-GB'); // 24h format
            logBox.innerHTML += `<div class="log-entry">[${time}] ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function togglePanel() {
            const panel = document.getElementById('statsPanel');
            const btn = document.getElementById('toggleIcon');
            const isCollapsed = panel.classList.toggle('panel-collapsed');
            btn.innerHTML = isCollapsed ? '▲' : '▼';
            if(!isCollapsed) {
                // 重新開啟時跑動畫
                animateValue("totalTargets", 0, allMarkers.length, 1000);
                animateValue("activeBrands", 0, labels.length, 1000);
            }
        }

        // 防止地圖穿透
        ['statsPanel', 'searchInput'].forEach(id => {
            const el = document.getElementById(id);
            if(el) { L.DomEvent.disableScrollPropagation(el); L.DomEvent.disableClickPropagation(el); }
        });

        // 初始化動畫
        animateValue("totalTargets", 0, allMarkers.length, 1500);
        animateValue("activeBrands", 0, labels.length, 1500);
        if(window.innerWidth < 600) togglePanel();

        logAction("TACTICAL MAP V6.0 READY.");
    </script>
</body>
</html>
