<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚ö°Ô∏è CHIAYI REGION DRINKS CYBER-MAP V5.5 ‚ö°Ô∏è</title>
    
    <!-- ÂºïÂÖ• Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #bc13fe;
            --neon-green: #0aff0a;
            --neon-yellow: #ffe600;
            --neon-magenta: #ff00ff;
            --neon-orange: #ffa500;
            --glass-bg: rgba(16, 20, 30, 0.85);
            --border-color: rgba(0, 243, 255, 0.3);
        }

        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0b0c10;
            color: #fff;
            overflow: hidden;
        }

        #map {
            height: 100vh; 
            width: 100%;
            z-index: 1;
            background: #0b0c10;
        }

        /* --- UI ÈÄöÁî®Ê®£Âºè (ÊØõÁéªÁíÉ) --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- 1. Â∑¶‰∏äÊ®ôÈ°åÂçÄ --- */
        .title-box {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            padding: 15px 25px;
            border-left: 4px solid var(--neon-blue);
            pointer-events: none;
        }
        .title-box * { pointer-events: auto; }

        .title-box h1 {
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #fff, var(--neon-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
        }

        .title-box p {
            margin: 5px 0 0 0;
            font-size: 0.85rem;
            color: #aaa;
            letter-spacing: 1px;
        }

        /* --- 2. È†ÇÈÉ®ÊêúÂ∞ãÂàó --- */
        .search-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 300px;
            display: flex;
            align-items: center;
        }

        .search-box input {
            width: 100%;
            background: transparent;
            border: none;
            padding: 12px 20px;
            color: #fff;
            font-family: 'Orbitron', 'Noto Sans TC';
            font-size: 1rem;
            outline: none;
            letter-spacing: 1px;
        }
        
        .search-box input::placeholder { color: rgba(0, 243, 255, 0.5); }
        
        .search-icon {
            padding-right: 15px;
            color: var(--neon-blue);
            font-size: 1.2rem;
        }

        /* --- 3. Âè≥‰∏ãÊéßÂà∂Èù¢Êùø --- */
        .chart-panel {
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            width: 340px;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        #toggleBtn {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            border-bottom: 1px solid var(--border-color);
            color: var(--neon-blue);
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            cursor: pointer;
            padding: 10px;
            font-size: 0.9rem;
            letter-spacing: 2px;
            outline: none;
            border-radius: 12px 12px 0 0;
            transition: background 0.3s;
        }
        #toggleBtn:hover { background: rgba(0, 243, 255, 0.1); }

        .chart-content {
            padding: 20px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--neon-blue) transparent;
        }
        .chart-content::-webkit-scrollbar { width: 6px; }
        .chart-content::-webkit-scrollbar-thumb { background-color: var(--neon-blue); border-radius: 3px; }

        .chart-panel h3 {
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--neon-pink);
            text-align: center;
            font-family: 'Orbitron', sans-serif;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
        }
        .chart-panel h3:first-child { margin-top: 0; }

        /* Á≥ªÁµ±Êó•Ë™å */
        .system-log {
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(10, 255, 10, 0.3);
            border-radius: 4px;
            padding: 10px;
            height: 100px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: var(--neon-green);
            text-shadow: 0 0 5px rgba(10, 255, 10, 0.5);
            scrollbar-width: none;
        }
        .log-entry { margin-bottom: 4px; opacity: 0.8; }
        .log-entry::before { content: '> '; opacity: 0.5; }

        .panel-collapsed .chart-content { display: none; }
        .panel-collapsed #toggleBtn { border-bottom: none; border-radius: 12px; }
        .panel-collapsed { width: auto; min-width: 150px; }

        /* --- 4. ÂÆö‰ΩçÊåâÈàï --- */
        .locate-btn {
            position: absolute;
            bottom: 40px;
            left: 30px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--neon-blue);
            font-size: 1.5rem;
            transition: all 0.3s;
        }
        .locate-btn:hover {
            box-shadow: 0 0 20px var(--neon-blue);
            transform: scale(1.1);
            background: rgba(0, 243, 255, 0.2);
        }
        .locate-btn:active { transform: scale(0.95); }

        /* --- ÂëºÂê∏ÁáàÊ®ôË®ò --- */
        .glowing-dot {
            width: 14px;
            height: 14px;
            background-color: currentColor;
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
            position: relative;
        }
        .glowing-dot::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 2px solid currentColor;
            animation: pulse-ring 2.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }

        /* Leaflet Popup (Ë≥áË®äË¶ñÁ™ó) */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: rgba(16, 20, 30, 0.95) !important;
            color: #fff !important;
            border: 1px solid var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
            backdrop-filter: blur(5px);
        }
        .leaflet-popup-content b { color: var(--neon-blue); font-family: 'Noto Sans TC'; font-size: 1.1em;}
        .leaflet-container a.leaflet-popup-close-button { color: var(--neon-blue) !important; }

        /* Â∞éËà™ÊåâÈàïÊ®£Âºè */
        .nav-btn {
            display: block;
            margin-top: 10px;
            background: linear-gradient(45deg, var(--neon-blue), #2196F3);
            color: #000;
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            text-decoration: none;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: bold;
            letter-spacing: 1px;
            transition: 0.3s;
        }
        .nav-btn:hover {
            filter: brightness(1.2);
            box-shadow: 0 0 10px var(--neon-blue);
        }
        .dist-info {
            color: var(--neon-yellow);
            font-family: 'Orbitron';
            font-size: 0.85rem;
            margin-top: 5px;
            border-top: 1px dashed rgba(255,255,255,0.2);
            padding-top: 5px;
        }

        /* RWD */
        @media (max-width: 600px) {
            .title-box { display: none; }
            .search-box { width: 80%; top: 15px; }
            .chart-panel { width: 85%; right: 7.5%; bottom: 90px; }
            .locate-btn { bottom: 25px; left: 25px; }
            .panel-collapsed { right: 20px; bottom: 20px; }
        }
    </style>
</head>
<body>

    <!-- Â∑¶‰∏äÊ®ôÈ°å -->
    <div class="title-box glass-panel">
        <h1>CHIAYI REGION<br>DRINKS MAP</h1>
        <p>ÂòâÁæ©Á∏£Â∏ÇÂÖ®ÂçÄ // V5.5 OSM Êà∞Ë°ìÂ¢ûÂº∑Áâà</p>
    </div>

    <!-- È†ÇÈÉ®ÊêúÂ∞ãÂàó -->
    <div class="search-box glass-panel">
        <input type="text" id="searchInput" placeholder="SEARCH TARGET..." onkeyup="filterMarkers()">
        <div class="search-icon">üîç</div>
    </div>

    <!-- Â∑¶‰∏ãÂÆö‰ΩçÊåâÈàï -->
    <div class="locate-btn glass-panel" onclick="locateUser()" title="Locate Me">
        ‚äï
    </div>

    <!-- Âè≥‰∏ãÊéßÂà∂Èù¢Êùø -->
    <div class="chart-panel glass-panel" id="statsPanel">
        <button id="toggleBtn" onclick="togglePanel()">‚ñº DATA MONITOR</button>
        
        <div class="chart-content">
            <h3>Brand Distribution</h3>
            <canvas id="brandChart"></canvas>
            
            <h3>Market Share</h3>
            <canvas id="shareChart"></canvas>
            
            <h3>System Log</h3>
            <div class="system-log" id="systemLog">
                <div class="log-entry">System initialized...</div>
                <div class="log-entry">Parsing OSM data packet...</div>
                <div class="log-entry">Waiting for GPS lock...</div>
            </div>

            <div style="margin-top: 10px; font-size: 0.7rem; color: #666; text-align: center;">
                SECURE CONNECTION ESTABLISHED
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // --- 1. Ë≥áÊñôËàáË®≠ÂÆö ---
        const brandColors = {
            "50Âµê": "#ffe600", 
            "Ëø∑ÂÆ¢Â§è": "#00ff88", 
            "ÂèØ‰∏çÂèØ": "#ff4d4d",
            "Ê∏ÖÂøÉÁ¶èÂÖ®": "#00d2ff", 
            "È∫ªÂè§Ëå∂Âùä": "#ff00dd", 
            "Â§ßËãëÂ≠ê": "#55ff00",
            "‰∫îÊ°êËôü": "#ffaa00",
            "ÂæóÊ≠£": "#00aaff",
            "ÈæúË®ò": "#ff5500",
            "ÂÖ´ÊõúÂíåËå∂": "#ccff00",
            "Ëå∂‰πãÈ≠îÊâã": "#ff0000",
            "Âæ°È¶ôÂ±ã": "#ffcc00", // ÂòâÁæ©ÂÇ≥Â•áËâ≤ (ÈáëÈªÉ)
            "ÈÆÆËå∂ÈÅì": "#ff00ff", // Êñ∞Â¢û: ÈúìËôπÊ¥ãÁ¥Ö
            "Tea's ÂéüÂë≥": "#ffa500", // Êñ∞Â¢û: ÈúìËôπÊ©ò
            "Ëå∂ÊπØÊúÉ": "#d2b48c", // Êñ∞Â¢û: Ëå∂Ëâ≤
            "ÂÖ∂‰ªñ": "#ffffff"
        };

        // ÂéüÂßãÊ®°Êì¨/Á≤æÈÅ∏Ë≥áÊñô (‰øùÁïôÁ∂ìÂÖ∏Âú∞Ê®ô)
        let shopsData = [
             // ‰øùÁïôÁ∂ìÂÖ∏Âú∞Ê®ô (Âæ°È¶ôÂ±ã)
            { name: "Ê∫êËààÂæ°È¶ôÂ±ã", brand: "Âæ°È¶ôÂ±ã", lat: 23.4800, lng: 120.4490, note: "ÂòâÁæ©Â∏Ç - ÊéíÈöäÂÇ≥Â•á! Ëë°ËêÑÊüöÁ∂†Ëå∂" },
            { name: "Ê∫êËààÂæ°È¶ôÂ±ã ‰∏≠Ê≠£‰∫åÂ∫ó", brand: "Âæ°È¶ôÂ±ã", lat: 23.4795, lng: 120.4505, note: "ÂòâÁæ©Â∏Ç - ÂÇ≥Â•á‰∫åÂ∫ó" },
            // ÂÖ∂‰ªñË≥áÊñôÂ∞áÁî± OSM Êï∏ÊìöË£úÂÖÖ...
        ];

        // OSM ÂåØÂÖ•ÁöÑÁúüÂØ¶Ë≥áÊñô
        const osmData = [
            { name: "Ê∂îËãëÂÜ∑È£≤", brand: "ÂÖ∂‰ªñ", lat: 23.3789281, lng: 120.1597254, note: "OSM Data" },
            { name: "Ëå∂ÁöÑÈ≠îÊâã", brand: "Ëå∂‰πãÈ≠îÊâã", lat: 23.3788733, lng: 120.1607136, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.3788624, lng: 120.1603330, note: "OSM Data" },
            { name: "È∫ªÂè§Ëå∂Âùä", brand: "È∫ªÂè§Ëå∂Âùä", lat: 23.4687985, lng: 120.4430873, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.4549948, lng: 120.2950259, note: "ÂòâÁæ©Á∏£Â§™‰øùÂ∏Ç - Â§™‰øù‰∫åË∑Ø" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.4581763, lng: 120.4434482, note: "ÂòâÁæ©Â∏ÇË•øÂçÄ - Ê∞ëÁîüÂçóË∑Ø" },
            { name: "Ëå∂ÊπØÊúÉ", brand: "Ëå∂ÊπØÊúÉ", lat: 23.4733369, lng: 120.4467844, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.4720331, lng: 120.4424876, note: "OSM Data" },
            { name: "50Âµê", brand: "50Âµê", lat: 23.4752538, lng: 120.4424574, note: "OSM Data" },
            { name: "Ëø∑ÂÆ¢Â§è", brand: "Ëø∑ÂÆ¢Â§è", lat: 23.4885137, lng: 120.4301848, note: "OSM Data" },
            { name: "Ê∏ÖÂøÉÁ¶èÂÖ®", brand: "Ê∏ÖÂøÉÁ¶èÂÖ®", lat: 23.4739623, lng: 120.4488383, note: "ÂòâÁæ©Â∏Ç - ÂûÇÊ•äË∑Ø" },
            { name: "Ëå∂ÁöÑÈ≠îÊâã", brand: "Ëå∂‰πãÈ≠îÊâã", lat: 23.4765376, lng: 120.4466494, note: "OSM Data" },
            { name: "Ê∏ÖÂøÉÁ¶èÂÖ®", brand: "Ê∏ÖÂøÉÁ¶èÂÖ®", lat: 23.4675845, lng: 120.4376656, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.4675690, lng: 120.4374327, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.4247620, lng: 120.5233964, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.4836878, lng: 120.4597618, note: "OSM Data" },
            { name: "Ëø∑ÂÆ¢Â§è", brand: "Ëø∑ÂÆ¢Â§è", lat: 23.4710021, lng: 120.4399223, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.4761335, lng: 120.4347360, note: "OSM Data" },
            { name: "Â§ßËãëÂ≠ê", brand: "Â§ßËãëÂ≠ê", lat: 23.4688681, lng: 120.4430558, note: "ÂòâÁæ©Â∏ÇË•øÂçÄ - ‰ªÅÊÑõË∑Ø" },
            { name: "50Âµê", brand: "50Âµê", lat: 23.4638350, lng: 120.2442200, note: "OSM Data" },
            { name: "50Âµê Â§ßÊûóÂ∫ó", brand: "50Âµê", lat: 23.6040911, lng: 120.4546392, note: "ÂòâÁæ©Á∏£Â§ßÊûóÈéÆ" },
            { name: "Ê∏ÖÂøÉÁ¶èÂÖ®", brand: "Ê∏ÖÂøÉÁ¶èÂÖ®", lat: 23.4945428, lng: 120.4439215, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.4890968, lng: 120.4462934, note: "OSM Data" },
            { name: "50Âµê", brand: "50Âµê", lat: 23.4562308, lng: 120.4590389, note: "OSM Data" },
            { name: "ÊèêÁ±≥ÂèØÂèØ", brand: "ÂÖ∂‰ªñ", lat: 23.4807843, lng: 120.4494542, note: "OSM Data" },
            { name: "Â§ßËãëÂ≠ê ÂòâÁæ©Á´ôÂâçÂ∫ó", brand: "Â§ßËãëÂ≠ê", lat: 23.4776981, lng: 120.4420335, note: "ÂòâÁæ©Â∏ÇË•øÂçÄ - ‰ªÅÊÑõË∑Ø" },
            { name: "Ëå∂ÊπØÊúÉ", brand: "Ëå∂ÊπØÊúÉ", lat: 23.4954015, lng: 120.4550269, note: "OSM Data" },
            { name: "50Âµê", brand: "50Âµê", lat: 23.4952699, lng: 120.4557699, note: "ÂòâÁæ©Â∏ÇÊù±ÂçÄ - Êñ∞ÁîüË∑Ø" },
            { name: "Tea's ÂéüÂë≥", brand: "Tea's ÂéüÂë≥", lat: 23.4529318, lng: 120.4600292, note: "OSM Data" },
            { name: "Ê∏ÖÂøÉÁ¶èÂÖ®", brand: "Ê∏ÖÂøÉÁ¶èÂÖ®", lat: 23.4523634, lng: 120.4604490, note: "OSM Data" },
            { name: "50Âµê", brand: "50Âµê", lat: 23.4675882, lng: 120.4376208, note: "OSM Data" },
            { name: "50Âµê", brand: "50Âµê", lat: 23.5231750, lng: 120.4397759, note: "OSM Data" },
            { name: "ÂèØ‰∏çÂèØÁÜüÊàêÁ¥ÖËå∂", brand: "ÂèØ‰∏çÂèØ", lat: 23.5234148, lng: 120.4397196, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.5362960, lng: 120.4365626, note: "OSM Data" },
            { name: "È∫ªÂè§Ëå∂Âùä", brand: "È∫ªÂè§Ëå∂Âùä", lat: 23.4849702, lng: 120.4481511, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.4770659, lng: 120.4604584, note: "OSM Data" },
            { name: "‰∏ÄÊâãÁßÅËóè‰∏ñÁïåÁ¥ÖËå∂", brand: "ÂÖ∂‰ªñ", lat: 23.4688252, lng: 120.4430545, note: "OSM Data" },
            { name: "Tea's ÂéüÂë≥", brand: "Tea's ÂéüÂë≥", lat: 23.4897887, lng: 120.4656780, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.5565500, lng: 120.4714563, note: "OSM Data" },
            { name: "Tea'sÂéüÂë≥", brand: "Tea's ÂéüÂë≥", lat: 23.5566162, lng: 120.4714601, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.4557369, lng: 120.4592031, note: "OSM Data" },
            { name: "ÂèØ‰∏çÂèØÁÜüÊàêÁ¥ÖËå∂", brand: "ÂèØ‰∏çÂèØ", lat: 23.4557000, lng: 120.4589644, note: "OSM Data" },
            { name: "Ëø∑ÂÆ¢Â§è", brand: "Ëø∑ÂÆ¢Â§è", lat: 23.4532123, lng: 120.4598871, note: "OSM Data" },
            { name: "TEA'SÂéüÂë≥ Áï™Ë∑ØËß∏Âè£Â∫ó", brand: "Tea's ÂéüÂë≥", lat: 23.4385378, lng: 120.6068509, note: "ÂòâÁæ©Á∏£Áï™Ë∑ØÈÑâ - Ëß∏Âè£Êùë" },
            { name: "Ê∏ÖÂøÉÁ¶èÂÖ® ‰∏≠Â±±Â∫ó", brand: "Ê∏ÖÂøÉÁ¶èÂÖ®", lat: 23.5849343, lng: 120.5557505, note: "ÂòâÁæ©Á∏£Ê¢ÖÂ±±ÈÑâ - ‰∏≠Â±±Ë∑Ø" },
            { name: "Á¥ÖËå∂Âπ´ Ê¢ÖÂ±±Â∫ó", brand: "ÂÖ∂‰ªñ", lat: 23.5848943, lng: 120.5554599, note: "ÂòâÁæ©Á∏£Ê¢ÖÂ±±ÈÑâ" },
            { name: "ÈÆÆËå∂ÈÅì Ê¢ÖÂ±±‰∏≠Â±±Â∫ó", brand: "ÈÆÆËå∂ÈÅì", lat: 23.5823817, lng: 120.5588006, note: "ÂòâÁæ©Á∏£Ê¢ÖÂ±±ÈÑâ" },
            { name: "ÂÖ´ÊõúÂíåËå∂", brand: "ÂÖ´ÊõúÂíåËå∂", lat: 23.4786717, lng: 120.4419774, note: "OSM Data" },
            { name: "Èï∑ÈùíÁâπÁî¢Ë°å", brand: "ÂÖ∂‰ªñ", lat: 23.5180647, lng: 120.8100896, note: "OSM Data" },
            { name: "50Âµê", brand: "50Âµê", lat: 23.4581911, lng: 120.4436250, note: "OSM Data" },
            { name: "Ëå∂ÁöÑÈ≠îÊâã", brand: "Ëå∂‰πãÈ≠îÊâã", lat: 23.4932701, lng: 120.4385288, note: "OSM Data" },
            { name: "Tea'sÂéüÂë≥", brand: "Tea's ÂéüÂë≥", lat: 23.4918913, lng: 120.4386983, note: "OSM Data" },
            { name: "ÈÆÆËå∂ÈÅì", brand: "ÈÆÆËå∂ÈÅì", lat: 23.4640894, lng: 120.5548749, note: "OSM Data" },
            { name: "Tea'sÂéüÂë≥ Á´πÂ¥é‰∏≠Â±±Â∫ó", brand: "Tea's ÂéüÂë≥", lat: 23.5198156, lng: 120.5496863, note: "ÂòâÁæ©Á∏£Á´πÂ¥éÈÑâ" }
        ];

        // Âêà‰ΩµË≥áÊñô
        shopsData = shopsData.concat(osmData);

        let allMarkers = [];
        let userMarker = null;
        let userLatLng = null;

        // --- 2. ÂàùÂßãÂåñÂú∞Âúñ ---
        // Á®çÂæÆÊãâÈÅ†‰∏ÄÈªûÔºåÂõ†ÁÇ∫ÁèæÂú®Ë≥áÊñôÊ∂µËìãÂà∞Ê¢ÖÂ±±„ÄÅÁï™Ë∑Ø
        const map = L.map('map', { zoomControl: false }).setView([23.4800, 120.4490], 12);
        L.control.zoom({ position: 'topright' }).addTo(map);

        const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', maxZoom: 20
        }).addTo(map);

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri', maxZoom: 17
        });

        // --- 3. Âª∫Á´ãÊ®ôË®ò (ÊîπÂØ´bindPopupÈÇèËºØ‰ª•ÊîØÊè¥ÂãïÊÖãË∑ùÈõ¢) ---
        const layers = {};
        const brandCounts = {};

        // ÂÆöÁæ© Popup ÂÖßÂÆπÁîüÊàêÂáΩÂºè
        function getPopupContent(shop) {
            let distInfo = "";
            let navUrl = `https://www.google.com/maps/dir/?api=1&destination=${shop.lat},${shop.lng}`;
            
            if (userLatLng) {
                // Ë®àÁÆóË∑ùÈõ¢ (ÂÖ¨Â∞∫)
                const distMeters = map.distance(userLatLng, [shop.lat, shop.lng]);
                const distKm = (distMeters / 1000).toFixed(1);
                
                // ‰º∞ÁÆóÊôÇÈñì (ÈñãËªäÂùáÈÄü 40km/h => 666 m/min)
                const etaMins = Math.ceil(distMeters / 666); 
                
                distInfo = `<div class="dist-info">
                                RANGE: ${distKm} KM<br>
                                ETA: ~${etaMins} MINS (DRIVE)
                            </div>`;
            } else {
                distInfo = `<div class="dist-info" style="color:#666;">
                                GPS SIGNAL LOST<br>CLICK [‚äï] TO CALC DISTANCE
                            </div>`;
            }

            return `
                <div style="font-family:'Orbitron'; font-size:0.8em; color:#888;">TARGET ACQUIRED</div>
                <b style="color: ${brandColors[shop.brand] || '#fff'}">${shop.name}</b><br>
                <span style="color:#aaa; border-top:1px solid #444; display:block; margin-top:4px; padding-top:4px;">${shop.note || "NO DATA"}</span>
                ${distInfo}
                <a href="${navUrl}" target="_blank" class="nav-btn">‚û§ INITIATE ROUTE</a>
            `;
        }

        shopsData.forEach(shop => {
            let bName = shop.brand;
            // ÂìÅÁâåÂêçÁ®±Ê≠£Ë¶èÂåñ (ËôïÁêÜ Tea's ÂéüÂë≥ Â§öÁ®ÆÂØ´Ê≥ï)
            if (bName.includes("Tea's") || bName.includes("TEA'S")) bName = "Tea's ÂéüÂë≥";
            
            if(!brandColors[bName]) bName = "ÂÖ∂‰ªñ";
            
            // ‰øÆÊ≠£ brand Ê¨Ñ‰Ωç‰ª•Âà©Áµ±Ë®à
            shop.brand = bName;

            brandCounts[shop.brand] = (brandCounts[shop.brand] || 0) + 1;
            const myColor = brandColors[bName] || brandColors["ÂÖ∂‰ªñ"];

            const isLegendary = shop.brand === "Âæ°È¶ôÂ±ã";
            const scale = isLegendary ? 1.5 : 1.0;
            const zIndexOffset = isLegendary ? 1000 : 0;

            const glowingIcon = L.divIcon({
                className: 'custom-pin',
                html: `<div class="glowing-dot" style="color: ${myColor}; transform: scale(${scale});"></div>`,
                iconSize: [20, 20], iconAnchor: [10, 10], popupAnchor: [0, -10]
            });

            const marker = L.marker([shop.lat, shop.lng], { icon: glowingIcon, zIndexOffset: zIndexOffset });
            
            // Á∂ÅÂÆöÂãïÊÖã Popup
            marker.bindPopup(() => getPopupContent(shop));
            
            marker.on('click', () => {
                logAction(`Target Locked: ${shop.name}`);
                if(userLatLng) {
                    const d = map.distance(userLatLng, [shop.lat, shop.lng]);
                    logAction(`Distance: ${(d/1000).toFixed(2)}km`);
                }
            });

            if (!layers[shop.brand]) layers[shop.brand] = L.layerGroup();
            layers[shop.brand].addLayer(marker);
            allMarkers.push({ marker: marker, data: shop });
        });

        for (let key in layers) layers[key].addTo(map);
        L.control.layers({ "Cyber Mode": darkLayer, "Real World": satelliteLayer }, layers, { collapsed: true }).addTo(map);

        // --- 4. ÂäüËÉΩÈÇèËºØ ---

        function filterMarkers() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            let count = 0;
            allMarkers.forEach(item => {
                const text = (item.data.name + item.data.brand + item.data.note).toLowerCase();
                if (text.includes(input)) {
                    item.marker.addTo(map);
                    count++;
                } else {
                    item.marker.remove();
                }
            });
            if(input.length > 0) logAction(`Search: "${input}" found ${count} targets`);
        }

        function locateUser() {
            logAction("Initiating GPS sequence...");
            map.locate({setView: true, maxZoom: 15});
            
            map.on('locationfound', function(e) {
                userLatLng = e.latlng;
                logAction(`GPS Locked: [${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}]`);
                
                if (userMarker) userMarker.remove();
                
                const userIcon = L.divIcon({
                    className: 'user-pin',
                    html: `<div class="glowing-dot" style="color: #00f3ff; transform: scale(1.5); box-shadow: 0 0 30px #00f3ff;"></div>`,
                    iconSize: [20, 20], iconAnchor: [10, 10]
                });
                
                userMarker = L.marker(e.latlng, {icon: userIcon}).addTo(map)
                    .bindPopup("<b>AGENT LOCATION</b><br>Tactical Support: Online").openPopup();
                
                L.circle(e.latlng, { radius: e.accuracy, color: '#00f3ff', weight: 1, fillOpacity: 0.1 }).addTo(map);

                // Êõ¥Êñ∞Êó•Ë™å
                logAction("System ready for distance calc.");
            });

            map.on('locationerror', function(e) {
                logAction("GPS Error: " + e.message);
                alert("ÁÑ°Ê≥ïÁç≤Âèñ‰ΩçÁΩÆÔºåË´ãÁ¢∫Ë™çÁÄèË¶ΩÂô®Ê¨äÈôê„ÄÇ");
            });
        }

        function logAction(msg) {
            const logBox = document.getElementById('systemLog');
            const time = new Date().toLocaleTimeString('en-US', {hour12: false});
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerText = `[${time}] ${msg}`;
            logBox.appendChild(entry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        // --- 5. ÂúñË°®Áπ™Ë£Ω ---
        
        ['statsPanel', 'searchInput'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                L.DomEvent.disableScrollPropagation(el);
                L.DomEvent.disableClickPropagation(el);
            }
        });

        function togglePanel() {
            const panel = document.getElementById('statsPanel');
            const btn = document.getElementById('toggleBtn');
            const isCollapsed = panel.classList.toggle('panel-collapsed');
            btn.innerHTML = isCollapsed ? '‚ñ≤ DATA MONITOR' : '‚ñº DATA MONITOR';
        }

        Chart.defaults.color = '#aaaaaa';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';
        Chart.defaults.font.family = "'Orbitron', sans-serif";
        
        const labels = Object.keys(brandCounts);
        const dataValues = Object.values(brandCounts);
        const bgColors = labels.map(l => brandColors[l] || brandColors["ÂÖ∂‰ªñ"]);

        new Chart(document.getElementById('brandChart'), {
            type: 'bar',
            data: { labels, datasets: [{ data: dataValues, backgroundColor: bgColors, borderRadius: 3 }] },
            options: { 
                responsive: true, maintainAspectRatio: false, aspectRatio: 2,
                scales: { y: { beginAtZero: true }, x: { grid: { display: false } } },
                plugins: { legend: { display: false } }
            }
        });

        new Chart(document.getElementById('shareChart'), {
            type: 'doughnut',
            data: { labels, datasets: [{ data: dataValues, backgroundColor: bgColors, borderColor: '#10141e', borderWidth: 2 }] },
            options: { 
                responsive: true, maintainAspectRatio: false, aspectRatio: 2, cutout: '65%',
                plugins: { legend: { position: 'right', labels: { boxWidth: 8, usePointStyle: true, font: { size: 10 } } } }
            }
        });

        if (window.innerWidth < 600) togglePanel();

        logAction("Full Scale Map systems online.");
        logAction(`Loaded ${shopsData.length} strategic targets.`);

    </script>
</body>
</html>
