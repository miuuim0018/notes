<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âš¡ï¸ CHIAYI TACTICAL MAP V12.0 RWD âš¡ï¸</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@300;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff0055;
            --neon-green: #00ff41;
            --neon-yellow: #ffee00;
            --bg-dark: #050a10;
            --panel-bg: rgba(5, 10, 16, 0.95);
        }

        body, html {
            height: 100%; margin: 0; padding: 0;
            font-family: 'Share Tech Mono', 'Noto Sans TC', monospace;
            background-color: var(--bg-dark);
            color: #e0e0e0;
            overflow: hidden; /* é˜²æ­¢æ‰‹æ©Ÿä¸‹æ‹‰é‡æ•´ */
        }

        #map { height: 100vh; width: 100%; z-index: 1; background: #000; }

        /* --- è³½åšé¾å…‹ UI --- */
        .cyber-panel {
            background: var(--panel-bg);
            border: 1px solid var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
            position: relative;
            backdrop-filter: blur(5px);
        }
        
        .cyber-panel::before, .cyber-panel::after {
            content: ''; position: absolute; width: 8px; height: 8px;
            border: 2px solid var(--neon-cyan); transition: all 0.3s;
        }
        .cyber-panel::before { top: -1px; left: -1px; border-right: none; border-bottom: none; }
        .cyber-panel::after { bottom: -1px; right: -1px; border-left: none; border-top: none; }

        /* --- 1. æ¨™é¡Œèˆ‡é ‚éƒ¨ RWD --- */
        .top-bar {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            pointer-events: none;
        }
        .main-title {
            font-family: 'Orbitron', sans-serif; font-size: 1.8rem;
            color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan);
            margin: 0; padding: 10px 20px; background: rgba(0,0,0,0.8);
            border-left: 4px solid var(--neon-cyan); pointer-events: auto;
            white-space: nowrap;
        }
        .sub-status { font-size: 0.8rem; color: var(--neon-green); margin-top: 5px; padding-left: 5px; text-shadow: 1px 1px 2px #000; }

        /* --- 2. æœå°‹æ¨¡çµ„ RWD --- */
        .search-module {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 300px; display: flex; align-items: center;
            background: rgba(0,0,0,0.9); border-bottom: 2px solid var(--neon-cyan);
            transition: width 0.3s;
        }
        .search-module input {
            width: 100%; background: transparent; border: none; padding: 10px;
            color: #fff; font-family: 'Orbitron', monospace; outline: none; font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
        }
        .search-blink { color: var(--neon-cyan); padding-right: 10px; animation: blink 1s infinite; }

        /* --- 3. æˆ°è¡“é¢æ¿ (é›»è…¦ç‰ˆé å³ï¼Œæ‰‹æ©Ÿç‰ˆé ä¸‹) --- */
        .tactical-panel {
            position: absolute; top: 80px; right: 20px; bottom: 30px;
            width: 380px; z-index: 2000; /* å±¤ç´šæœ€é«˜ */
            display: flex; flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .panel-header {
            padding: 15px; background: rgba(0, 243, 255, 0.15);
            border-bottom: 1px solid var(--neon-cyan);
            display: flex; justify-content: space-between; cursor: pointer;
            font-family: 'Orbitron'; font-weight: bold; color: var(--neon-cyan);
            user-select: none;
        }
        
        .panel-body {
            flex: 1; overflow-y: auto; padding: 15px;
            background: rgba(5, 10, 16, 0.98);
            scrollbar-width: thin; scrollbar-color: var(--neon-cyan) #000;
        }

        /* --- éŸ¿æ‡‰å¼ä½ˆå±€è¨­å®š (é—œéµ) --- */
        @media (max-width: 768px) {
            /* æ¨™é¡Œè®Šå° */
            .main-title { font-size: 1.2rem; padding: 8px 12px; }
            .top-bar { top: 10px; left: 10px; }
            
            /* æœå°‹æ¡†ä¸‹ç§»ä¸¦æ»¿ç‰ˆ */
            .search-module { 
                top: 70px; width: 90%; 
                background: rgba(5, 10, 16, 0.95);
            }

            /* é¢æ¿è®Šç‚ºåº•éƒ¨æŠ½å±œ */
            .tactical-panel {
                top: auto; bottom: 0; right: 0; left: 0;
                width: 100%; height: 60vh; /* æ‰“é–‹æ™‚çš„é«˜åº¦ */
                border-left: none; border-right: none;
                transform: translateY(0); /* é è¨­æ‰“é–‹ */
            }

            /* æ”¶åˆç‹€æ…‹ï¼šåªéœ²å‡ºæ¨™é¡Œ */
            .panel-collapsed {
                transform: translateY(calc(100% - 50px)) !important; /* 50px æ˜¯ header é«˜åº¦ */
            }

            /* GPS æŒ‰éˆ•ä½ç½®èª¿æ•´ */
            .gps-btn { bottom: 120px; left: 10px; width: 45px; height: 45px; }

            /* éš±è—éƒ¨åˆ†é›»è…¦ç‰ˆç´°ç¯€ä»¥ç¯€çœç©ºé–“ */
            .sub-status { display: none; } 
        }

        /* é›»è…¦ç‰ˆæ”¶åˆç‹€æ…‹ */
        @media (min-width: 769px) {
            .panel-collapsed { transform: translateX(110%); }
        }

        /* --- åœ–è¡¨èˆ‡è¡¨æ ¼ --- */
        .chart-wrapper { height: 200px; width: 100%; margin-bottom: 20px; position: relative; }
        .section-header {
            color: var(--neon-pink); border-bottom: 1px dashed var(--neon-pink);
            margin-bottom: 10px; padding-bottom: 5px; font-size: 0.9rem;
        }
        .cyber-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.8rem; }
        .cyber-table th { text-align: left; padding: 8px; color: var(--neon-cyan); border-bottom: 1px solid var(--neon-cyan); }
        .cyber-table td { padding: 6px 8px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; vertical-align: middle; }
        .brand-icon-sm { width: 20px; height: 20px; border-radius: 50%; border: 1px solid var(--neon-cyan); background: #fff; object-fit: cover; vertical-align: middle; margin-right: 8px; }

        .reset-btn { width: 100%; padding: 8px; margin-bottom: 15px; background: rgba(255, 0, 85, 0.2); border: 1px solid var(--neon-pink); color: var(--neon-pink); cursor: pointer; font-family: 'Orbitron'; display: none; }

        /* GPS æŒ‰éˆ• */
        .gps-btn {
            position: absolute; bottom: 30px; left: 20px; z-index: 1000;
            width: 50px; height: 50px; border-radius: 50%;
            border: 2px solid var(--neon-cyan);
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.8); cursor: pointer;
            box-shadow: 0 0 15px rgba(0,243,255,0.2);
            transition: all 0.3s;
        }
        .gps-icon { width: 24px; height: 24px; fill: var(--neon-cyan); }

        /* Leaflet Popup RWD */
        .leaflet-popup-content-wrapper { background: rgba(10, 15, 20, 0.95) !important; border: 1px solid var(--neon-cyan); border-radius: 0 !important; color: #fff !important; min-width: 220px; }
        .leaflet-popup-tip { background: var(--neon-cyan) !important; }
        .pop-header-flex { display: flex; align-items: center; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; }
        .pop-logo-lg { width: 32px; height: 32px; border-radius: 50%; background: #fff; border: 2px solid var(--neon-cyan); margin-right: 10px; object-fit: cover; }
        .pop-title { font-size:1.1rem; font-weight:bold; }
        .pop-btn { display: block; margin-top: 8px; padding: 10px; background: rgba(0, 243, 255, 0.2); color: var(--neon-cyan); text-align: center; text-decoration: none; border: 1px solid var(--neon-cyan); font-size: 1rem; }

        .glowing-dot { width: 12px; height: 12px; background: currentColor; border-radius: 50%; box-shadow: 0 0 8px currentColor; position: relative; }

        /* åœ–å±¤æ§åˆ¶å™¨æ¨£å¼ */
        .leaflet-control-layers {
            background: rgba(5, 10, 16, 0.95) !important;
            border: 1px solid var(--neon-cyan) !important;
            color: var(--neon-cyan) !important;
            border-radius: 0 !important;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2) !important;
            font-family: 'Orbitron', sans-serif; font-size: 0.8rem;
        }
        .leaflet-control-layers-toggle { filter: invert(1) drop-shadow(0 0 2px cyan); }
        .leaflet-control-layers-base label span { color: #fff; margin-left: 5px; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="top-bar">
        <h1 class="main-title cyber-panel">CHIAYI OPS</h1>
        <div class="sub-status">SYS: V12.0 RWD | MODE: MOBILE_READY</div>
    </div>

    <div class="search-module cyber-panel">
        <div class="search-blink">â–ˆ</div>
        <input type="text" id="searchInput" placeholder="SEARCH TARGET..." onkeyup="filterSystem()">
    </div>

    <div class="gps-btn" onclick="activateGPS()" title="SYNC LOC">
        <svg class="gps-icon" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
    </div>

    <div class="tactical-panel cyber-panel" id="rightPanel">
        <div class="panel-header" onclick="togglePanel()">
            <span>/// INTELLIGENCE_GRID</span>
            <span id="toggleState">[-]</span>
        </div>
        
        <div class="panel-body">
            <button id="resetBtn" class="reset-btn" onclick="resetFilter()">âš  RESET FILTER âš </button>

            <div class="section-header"><span>TOP BRANDS RANKING</span></div>
            <table class="cyber-table">
                <thead>
                    <tr><th class="rank-col">#</th><th>BRAND</th><th class="count-col">QTY</th><th class="count-col">%</th></tr>
                </thead>
                <tbody id="brandTableBody"></tbody>
            </table>

            <div class="section-header"><span>MARKET SHARE</span></div>
            <div class="chart-wrapper"><canvas id="barChart"></canvas></div>

            <div class="section-header"><span>TACTICAL RADAR</span></div>
            <div class="chart-wrapper"><canvas id="radarChart"></canvas></div>

            <div style="margin-top:20px; padding:10px; background:#000; color:var(--neon-green); font-size:0.7rem; border:1px solid #333; height:80px; overflow-y:auto;" id="sysLog">
                > System V12.0 RWD Loaded...<br>
                > Mobile/Desktop Mode detected.<br>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // --- 0. è¨­å®šèˆ‡è³‡ç”¢ ---
        const brandLogos = {
            "50åµ": "https://upload.wikimedia.org/wikipedia/zh/7/7a/50_Lan_logo.png",
            "è¿·å®¢å¤": "https://www.milksha.com/images/logo_w.png",
            "å¯ä¸å¯": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ0KfjdjbQMREiS_dkFvQT9VkLxC5N4fZjGSQ&s",
            "æ¸…å¿ƒç¦å…¨": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQndNRiSVFN_AN0oTmTBVh0lBZMDTgRDfoN5Q&s",
            "éº»å¤èŒ¶åŠ": "https://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/MACU_logo.svg/160px-MACU_logo.svg.png",
            "å¤§è‹‘å­": "https://upload.wikimedia.org/wikipedia/zh/6/66/Da_Yung%27s_logo.jpg",
            "é®®èŒ¶é“": "https://foodtracer.health.ntpc.gov.tw/WebUPD/foodtracer/FoodCompany/%E9%AE%AE%E8%8C%B6%E9%81%93presotea_22030416494191607.png",
            "Tea's åŸå‘³": "https://images.deliveryhero.io/image/fd-tw/tw-logos/ch3ui-logo.jpg",
            "èŒ¶ä¹‹é­”æ‰‹": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSfF_jgRrN6gufH3mVWQL9giqdwS7Whl1jZHg&s",
            "èŒ¶æ¹¯æœƒ": "https://images.1111.com.tw/oad/50557173.jpg",
            "å…«æ›œå’ŒèŒ¶": "https://8yotea.com/wp-content/uploads/superforms/909719990/-logo%E9%80%8F%E6%98%8E01.png",
            "å¾¡é¦™å±‹": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRkbPO6raZUknTsKSmSZsDIcqgaaBsJK0vy8A&s",
            "å…¶ä»–": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzAwZjNmZiI+PHBhdGggZD0iTTEyIDJDMiAxMiAyIDEyIDIgMTJzMCAxMiAxMCAxMmMxMiAwIDEyLTAgMTItMTJTMjIgMiAxMiAyeiIvPjwvc3ZnPg=="
        };

        const brandColors = {
            "50åµ": "#ffe600", "è¿·å®¢å¤": "#00ff88", "å¯ä¸å¯": "#ff4d4d",
            "æ¸…å¿ƒç¦å…¨": "#00d2ff", "éº»å¤èŒ¶åŠ": "#ff00dd", "å¤§è‹‘å­": "#55ff00",
            "é®®èŒ¶é“": "#ff00ff", "Tea's åŸå‘³": "#ffa500", "èŒ¶ä¹‹é­”æ‰‹": "#ff0000",
            "èŒ¶æ¹¯æœƒ": "#d2b48c", "å…«æ›œå’ŒèŒ¶": "#ccff00", "å¾¡é¦™å±‹": "#ffcc00", "å…¶ä»–": "#ffffff"
        };

        // --- 1. è³‡æ–™è™•ç† (OSM Mock Data) ---
        const osmRaw = {
          "elements": [
            { "type": "node", "lat": 23.3788733, "lon": 120.1607136, "tags": { "brand": "èŒ¶çš„é­”æ‰‹", "name": "èŒ¶çš„é­”æ‰‹" } },
            { "type": "node", "lat": 23.4687985, "lon": 120.4430873, "tags": { "brand": "éº»å¤èŒ¶åŠ", "name": "éº»å¤èŒ¶åŠ" } },
            { "type": "node", "lat": 23.4581763, "lon": 120.4434482, "tags": { "brand": "é®®èŒ¶é“", "name": "é®®èŒ¶é“", "addr:street": "æ°‘ç”Ÿå—è·¯" } },
            { "type": "node", "lat": 23.4752538, "lon": 120.4424574, "tags": { "brand": "50åµ", "name": "50åµ" } },
            { "type": "node", "lat": 23.4885137, "lon": 120.4301848, "tags": { "brand": "è¿·å®¢å¤", "name": "è¿·å®¢å¤" } },
            { "type": "node", "lat": 23.4739623, "lon": 120.4488383, "tags": { "brand": "æ¸…å¿ƒç¦å…¨", "name": "æ¸…å¿ƒç¦å…¨", "addr:street": "å‚æ¥Šè·¯" } },
            { "type": "node", "lat": 23.4675690, "lon": 120.4374327, "tags": { "brand": "é®®èŒ¶é“", "name": "é®®èŒ¶é“" } },
            { "type": "node", "lat": 23.4836878, "lon": 120.4597618, "tags": { "brand": "é®®èŒ¶é“", "name": "é®®èŒ¶é“" } },
            { "type": "node", "lat": 23.4688681, "lon": 120.4430558, "tags": { "brand": "å¤§è‹‘å­", "name": "å¤§è‹‘å­", "addr:street": "ä»æ„›è·¯" } },
            { "type": "node", "lat": 23.4638350, "lon": 120.2442200, "tags": { "brand": "50åµ", "name": "50åµ" } },
            { "type": "node", "lat": 23.4945428, "lon": 120.4439215, "tags": { "brand": "æ¸…å¿ƒç¦å…¨", "name": "æ¸…å¿ƒç¦å…¨" } },
            { "type": "node", "lat": 23.4562308, "lon": 120.4590389, "tags": { "brand": "50åµ", "name": "50åµ" } },
            { "type": "node", "lat": 23.4776981, "lon": 120.4420335, "tags": { "brand": "å¤§è‹‘å­", "name": "å¤§è‹‘å­", "branch": "å˜‰ç¾©ç«™å‰åº—" } },
            { "type": "node", "lat": 23.4952699, "lon": 120.4557699, "tags": { "brand": "50åµ", "name": "50åµ", "addr:street": "æ–°ç”Ÿè·¯" } },
            { "type": "node", "lat": 23.4529318, "lon": 120.4600292, "tags": { "name": "Tea's åŸå‘³" } },
            { "type": "node", "lat": 23.4523634, "lon": 120.4604490, "tags": { "brand": "æ¸…å¿ƒç¦å…¨", "name": "æ¸…å¿ƒç¦å…¨" } },
            { "type": "node", "lat": 23.4675882, "lon": 120.4376208, "tags": { "brand": "50åµ", "name": "50åµ" } },
            { "type": "node", "lat": 23.5234148, "lon": 120.4397196, "tags": { "brand": "å¯ä¸å¯ç†Ÿæˆç´…èŒ¶", "name": "å¯ä¸å¯ç†Ÿæˆç´…èŒ¶" } },
            { "type": "node", "lat": 23.4849702, "lon": 120.4481511, "tags": { "brand": "éº»å¤èŒ¶åŠ", "name": "éº»å¤èŒ¶åŠ" } },
            { "type": "node", "lat": 23.4897887, "lon": 120.4656780, "tags": { "name": "Tea's åŸå‘³" } },
            { "type": "node", "lat": 23.5566162, "lon": 120.4714601, "tags": { "name": "Tea'såŸå‘³" } },
            { "type": "node", "lat": 23.4557000, "lon": 120.4589644, "tags": { "brand": "å¯ä¸å¯ç†Ÿæˆç´…èŒ¶", "name": "å¯ä¸å¯ç†Ÿæˆç´…èŒ¶" } },
            { "type": "node", "lat": 23.4532123, "lon": 120.4598871, "tags": { "brand": "è¿·å®¢å¤", "name": "è¿·å®¢å¤" } },
            { "type": "node", "lat": 23.4385378, "lon": 120.6068509, "tags": { "name": "TEA'SåŸå‘³", "branch": "ç•ªè·¯è§¸å£åº—", "addr:district": "ç•ªè·¯é„‰" } },
            { "type": "node", "lat": 23.5849343, "lon": 120.5557505, "tags": { "brand": "æ¸…å¿ƒç¦å…¨", "name": "æ¸…å¿ƒç¦å…¨", "addr:district": "æ¢…å±±é„‰" } },
            { "type": "node", "lat": 23.4786717, "lon": 120.4419774, "tags": { "brand": "å…«æ›œå’ŒèŒ¶", "name": "å…«æ›œå’ŒèŒ¶" } },
            { "type": "node", "lat": 23.4932701, "lon": 120.4385288, "tags": { "brand": "èŒ¶çš„é­”æ‰‹", "name": "èŒ¶çš„é­”æ‰‹" } },
            { "type": "node", "lat": 23.4918913, "lon": 120.4386983, "tags": { "name": "Tea'såŸå‘³" } },
            { "type": "way", "center": { "lat": 23.5198156, "lon": 120.5496863 }, "tags": { "name": "Tea'såŸå‘³", "branch": "ç«¹å´ä¸­å±±åº—" } }
          ]
        };

        let shopsData = [
            { name: "æºèˆˆå¾¡é¦™å±‹", brand: "å¾¡é¦™å±‹", lat: 23.4800, lng: 120.4490, note: "å˜‰ç¾©å¸‚ - å™´æ°´åœ“ç’°å‚³å¥‡" },
            { name: "æºèˆˆå¾¡é¦™å±‹ ä¸­æ­£äºŒåº—", brand: "å¾¡é¦™å±‹", lat: 23.4795, lng: 120.4505, note: "å˜‰ç¾©å¸‚" }
        ];

        osmRaw.elements.forEach(el => {
            let lat = el.lat || el.center?.lat;
            let lng = el.lon || el.center?.lon;
            if(!lat || !lng) return;

            let name = el.tags.name || "æœªçŸ¥åº—å®¶";
            let rawBrand = (el.tags.brand || name).toUpperCase();
            let note = "";
            if(el.tags["addr:district"]) note += el.tags["addr:district"] + " ";
            if(el.tags["addr:street"]) note += el.tags["addr:street"] + " ";
            if(el.tags.branch) note += el.tags.branch;
            if(note === "") note = "OSM_DATA_GRID";

            let brand = "å…¶ä»–";
            if (name.includes("å¾¡é¦™å±‹")) brand = "å¾¡é¦™å±‹";
            else if (rawBrand.includes("50åµ")) brand = "50åµ";
            else if (rawBrand.includes("è¿·å®¢å¤")) brand = "è¿·å®¢å¤";
            else if (rawBrand.includes("å¯ä¸å¯")) brand = "å¯ä¸å¯";
            else if (rawBrand.includes("æ¸…å¿ƒ")) brand = "æ¸…å¿ƒç¦å…¨";
            else if (rawBrand.includes("éº»å¤")) brand = "éº»å¤èŒ¶åŠ";
            else if (rawBrand.includes("å¤§è‹‘å­")) brand = "å¤§è‹‘å­";
            else if (rawBrand.includes("é®®èŒ¶é“")) brand = "é®®èŒ¶é“";
            else if (rawBrand.includes("TEA'S") || rawBrand.includes("TEAS")) brand = "Tea's åŸå‘³";
            else if (rawBrand.includes("èŒ¶çš„é­”æ‰‹") || rawBrand.includes("èŒ¶ä¹‹é­”æ‰‹")) brand = "èŒ¶ä¹‹é­”æ‰‹";
            else if (rawBrand.includes("èŒ¶æ¹¯æœƒ")) brand = "èŒ¶æ¹¯æœƒ";
            else if (rawBrand.includes("å…«æ›œ")) brand = "å…«æ›œå’ŒèŒ¶";

            shopsData.push({ name, brand, lat, lng, note });
        });

        // --- 2. åˆå§‹åŒ–åœ°åœ–èˆ‡æ­·å²åœ–å±¤ ---
        const map = L.map('map', { zoomControl: false }).setView([23.4800, 120.4490], 14);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© CARTO', maxZoom: 20 });
        const layer1904 = L.tileLayer('https://gis.sinica.edu.tw/tileserver/file-exists.php?img=JM20K_1904-jpg-{z}-{x}-{y}', { attribution: 'Â© ä¸­ç ”é™¢ GIS', maxZoom: 20, maxNativeZoom: 14 });
        const layer1921 = L.tileLayer('https://gis.sinica.edu.tw/tileserver/file-exists.php?img=JM20K_1921-jpg-{z}-{x}-{y}', { attribution: 'Â© ä¸­ç ”é™¢ GIS', maxZoom: 20, maxNativeZoom: 14 });
        const layer1993 = L.tileLayer('https://gis.sinica.edu.tw/tileserver/file-exists.php?img=TM25K_1993-jpg-{z}-{x}-{y}', { attribution: 'Â© ä¸­ç ”é™¢ GIS', maxZoom: 20, maxNativeZoom: 15 });

        darkLayer.addTo(map);

        const baseMaps = {
            "âš¡ CYBER 2024": darkLayer,
            "ğŸ“œ 1904 æ—¥æ²»å ¡åœ–": layer1904,
            "ğŸ¨ 1921 æ—¥æ²»åœ°å½¢": layer1921,
            "ğŸ—ï¸ 1993 ç¶“å»ºç‰ˆ": layer1993
        };
        L.control.layers(baseMaps).addTo(map);

        // --- 3. æ¨™è¨˜èˆ‡äº’å‹• ---
        const layers = {};
        const brandCounts = {};
        const allMarkers = [];
        let currentFilter = null;
        let userLatLng = null;
        let userMarker = null;

        shopsData.forEach(shop => {
            brandCounts[shop.brand] = (brandCounts[shop.brand] || 0) + 1;
            const color = brandColors[shop.brand] || "#fff";
            const logoUrl = brandLogos[shop.brand] || brandLogos["å…¶ä»–"];
            
            const icon = L.divIcon({
                className: 'custom-pin',
                html: `<div class="glowing-dot" style="color: ${color}; transform: scale(${shop.brand==="å¾¡é¦™å±‹"?1.5:1})"></div>`,
                iconSize: [20, 20], iconAnchor: [10, 10], popupAnchor: [0, -10]
            });

            const marker = L.marker([shop.lat, shop.lng], { icon: icon });
            
            marker.bindPopup(() => {
                const dist = userLatLng ? (map.distance(userLatLng, [shop.lat, shop.lng])/1000).toFixed(1) + " KM" : "GPS OFFLINE";
                return `
                    <div class="pop-header-flex">
                        <img src="${logoUrl}" class="pop-logo-lg">
                        <div class="pop-title" style="color:${color};">${shop.name}</div>
                    </div>
                    <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">${shop.note}</div>
                    <div style="border-top:1px dashed #555; padding-top:5px; color:var(--neon-yellow);">DIST: ${dist}</div>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=$?q=$${shop.lat},${shop.lng}" target="_blank" class="pop-btn">>> NAVIGATE <<</a>
                `;
            });

            if (!layers[shop.brand]) layers[shop.brand] = L.layerGroup();
            layers[shop.brand].addLayer(marker);
            allMarkers.push({ marker, data: shop });
        });

        for (let k in layers) layers[k].addTo(map);
        document.getElementById('brandTableBody').innerHTML = ""; // Clear Init

        // --- 4. æ•¸æ“šè¦–è¦ºåŒ– ---
        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = 'rgba(0, 243, 255, 0.1)';
        Chart.defaults.font.family = "'Orbitron', sans-serif";

        const labels = Object.keys(brandCounts).sort((a,b) => brandCounts[b] - brandCounts[a]);
        const dataVals = labels.map(l => brandCounts[l]);
        const bgColors = labels.map(l => brandColors[l] || '#fff');

        const tbody = document.getElementById('brandTableBody');
        labels.forEach((label, idx) => {
            const count = brandCounts[label];
            const percent = ((count / shopsData.length) * 100).toFixed(1);
            const logoUrl = brandLogos[label] || brandLogos["å…¶ä»–"];
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="rank-col">#${idx+1}</td>
                <td style="color:${brandColors[label]||'#fff'}">
                    <img src="${logoUrl}" class="brand-icon-sm"> ${label}
                </td>
                <td class="count-col">${count}</td>
                <td class="count-col">${percent}%</td>
            `;
            tr.onclick = () => filterMap(label);
            tbody.appendChild(tr);
        });

        new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: labels, datasets: [{ data: dataVals, backgroundColor: bgColors, borderRadius: 3, barThickness: 12 }] },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' } }, y: { grid: { display: false }, ticks: { color: '#fff', font: { size: 9 } } } }, plugins: { legend: { display: false } }, onClick: (e, els) => { if(els.length > 0) filterMap(labels[els[0].index]); } }
        });

        const top5 = labels.slice(0, 5);
        new Chart(document.getElementById('radarChart'), {
            type: 'radar',
            data: {
                labels: ['DENSITY', 'SPEED', 'PRICE', 'RANGE', 'HYPE'],
                datasets: top5.map((brand) => ({
                    label: brand,
                    data: [ (brandCounts[brand]/Math.max(...dataVals))*100, Math.random()*30+70, Math.random()*30+70, Math.random()*30+70, Math.random()*30+70 ],
                    borderColor: brandColors[brand], backgroundColor: 'transparent', borderWidth: 2, pointRadius: 0
                }))
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' }, angleLines: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#aaa', font: { size: 9 } } } }, plugins: { legend: { labels: { color: '#fff', font: { size: 9 }, boxWidth: 8 } } } }
        });

        // --- 5. æ ¸å¿ƒé‚è¼¯ ---
        function log(msg) {
            const el = document.getElementById('sysLog');
            el.innerHTML += `> ${msg}<br>`;
            el.scrollTop = el.scrollHeight;
        }

        function filterSystem() {
            const txt = document.getElementById('searchInput').value.toLowerCase();
            allMarkers.forEach(m => {
                const visible = m.data.name.toLowerCase().includes(txt) || m.data.brand.toLowerCase().includes(txt);
                visible ? m.marker.addTo(map) : m.marker.remove();
            });
        }

        function filterMap(brand) {
            const btn = document.getElementById('resetBtn');
            if(currentFilter === brand) return resetFilter();
            currentFilter = brand;
            btn.style.display = 'block';
            for(let k in layers) map.removeLayer(layers[k]);
            if(layers[brand]) {
                map.addLayer(layers[brand]);
                const target = allMarkers.find(m => m.data.brand === brand);
                if(target) map.flyTo(target.marker.getLatLng(), 13);
            }
            log(`FILTER ACTIVE: ${brand}`);
            
            // æ‰‹æ©Ÿç‰ˆè‡ªå‹•æ”¶åˆé¢æ¿ä»¥ä¾¿çœ‹åœ°åœ–
            if(window.innerWidth < 768) {
                document.getElementById('rightPanel').classList.add('panel-collapsed');
                document.getElementById('toggleState').innerText = '[+]';
            }
        }

        function resetFilter() {
            const btn = document.getElementById('resetBtn');
            currentFilter = null;
            btn.style.display = 'none';
            for(let k in layers) if(!map.hasLayer(layers[k])) map.addLayer(layers[k]);
            log("FILTER RESET");
        }

        function togglePanel() {
            const p = document.getElementById('rightPanel');
            const s = document.getElementById('toggleState');
            p.classList.toggle('panel-collapsed');
            s.innerText = p.classList.contains('panel-collapsed') ? '[+]' : '[-]';
        }

        function activateGPS() {
            log("SCANNING GPS...");
            map.locate({ setView: true, maxZoom: 14 });
            map.on('locationfound', e => {
                userLatLng = e.latlng;
                if(userMarker) userMarker.remove();
                const gpsIcon = L.divIcon({ className: 'custom-pin', html: `<div style="width:16px;height:16px;background:#00f3ff;border-radius:50%;box-shadow:0 0 20px #00f3ff;border:2px solid #fff;"></div>`, iconSize: [20, 20] });
                userMarker = L.marker(e.latlng, {icon: gpsIcon}).addTo(map).bindPopup("OPERATOR LOCATION").openPopup();
                log("LOCATION LOCKED.");
            });
        }

        ['rightPanel', 'searchInput'].forEach(id => {
            const el = document.getElementById(id);
            if(el) { L.DomEvent.disableScrollPropagation(el); L.DomEvent.disableClickPropagation(el); }
        });

        // é è¨­æ”¶åˆé¢æ¿ (æ‰‹æ©Ÿç‰ˆ)
        if(window.innerWidth < 768) togglePanel();
        
        log(`SYSTEM READY. ${shopsData.length} TARGETS.`);
    </script>
</body>
</html>
